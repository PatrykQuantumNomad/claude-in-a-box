# Architecture Research

**Domain:** Astro landing page integration into existing DevOps tool repository
**Researched:** 2026-02-25
**Confidence:** HIGH

## System Overview

```
claude-in-a-box/
├─────────────────────────────────────────────────────────────────┐
│  EXISTING PRODUCT CODE (unchanged)                              │
│  ┌──────────┐  ┌──────┐  ┌──────┐  ┌───────┐  ┌──────────┐    │
│  │ docker/  │  │ k8s/ │  │helm/ │  │tests/ │  │ scripts/ │    │
│  └──────────┘  └──────┘  └──────┘  └───────┘  └──────────┘    │
│  Makefile  docker-compose.yaml  kind/                           │
├─────────────────────────────────────────────────────────────────┤
│  NEW LANDING PAGE (isolated)                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  site/                   -- Astro project root           │   │
│  │  ├── src/pages/          -- File-based routing           │   │
│  │  ├── src/components/     -- UI components                │   │
│  │  ├── src/layouts/        -- Page layouts                 │   │
│  │  ├── src/styles/         -- Global CSS / Tailwind        │   │
│  │  ├── public/             -- Static assets + CNAME        │   │
│  │  ├── astro.config.mjs    -- Site config                  │   │
│  │  └── package.json        -- Astro dependencies           │   │
│  └──────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  CI/CD LAYER                                                    │
│  ┌───────────────────────────────────────┐                      │
│  │  .github/workflows/                   │                      │
│  │  ├── ci.yaml          -- existing, add paths-ignore         │
│  │  └── deploy-site.yaml -- NEW: Astro build + GitHub Pages   │
│  └───────────────────────────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

### Component Responsibilities

| Component | Responsibility | Typical Implementation |
|-----------|----------------|------------------------|
| `site/` | Landing page source code, fully isolated from product | Astro 5 project with Tailwind CSS v4 |
| `site/src/pages/` | Page routing (single page for landing) | `index.astro` -- the landing page |
| `site/src/components/` | Reusable UI sections | Hero, Features, QuickStart, Architecture, Footer |
| `site/src/layouts/` | Page wrapper template | Base layout with `<head>`, meta tags, Open Graph |
| `site/public/` | Static assets served verbatim | Favicon, OG image, `CNAME` file for custom domain |
| `site/astro.config.mjs` | Build configuration | Site URL, Tailwind integration |
| `.github/workflows/deploy-site.yaml` | Landing page CI/CD | Build Astro + deploy to GitHub Pages |
| `.github/workflows/ci.yaml` | Product CI/CD (existing) | Add `paths-ignore: ['site/**']` to avoid false triggers |

## Recommended Project Structure

```
claude-in-a-box/                    # repo root (unchanged layout)
├── .github/
│   └── workflows/
│       ├── ci.yaml                 # EXISTING -- add paths-ignore for site/**
│       └── deploy-site.yaml        # NEW -- Astro build + GitHub Pages deploy
├── docker/                         # EXISTING -- no changes
├── helm/                           # EXISTING -- no changes
├── k8s/                            # EXISTING -- no changes
├── kind/                           # EXISTING -- no changes
├── scripts/                        # EXISTING -- no changes
├── tests/                          # EXISTING -- no changes
├── site/                           # NEW -- Astro project root
│   ├── public/
│   │   ├── CNAME                   # Contains: remotekube.patrykgolabek.dev
│   │   ├── favicon.svg             # Site favicon
│   │   └── og-image.png            # Social media preview image
│   ├── src/
│   │   ├── components/
│   │   │   ├── Header.astro        # Navigation header
│   │   │   ├── Hero.astro          # Hero/headline section
│   │   │   ├── Features.astro      # Feature highlights grid
│   │   │   ├── QuickStart.astro    # Installation / getting started
│   │   │   ├── Architecture.astro  # Architecture diagram section
│   │   │   └── Footer.astro        # Footer with links
│   │   ├── layouts/
│   │   │   └── Base.astro          # HTML shell: head, meta, body wrapper
│   │   ├── pages/
│   │   │   └── index.astro         # Landing page (imports layout + components)
│   │   └── styles/
│   │       └── global.css          # Tailwind directives + custom styles
│   ├── astro.config.mjs            # Astro configuration
│   ├── tailwind.config.mjs         # Tailwind configuration
│   ├── tsconfig.json               # TypeScript config (Astro strict preset)
│   ├── package.json                # Astro + Tailwind dependencies
│   └── package-lock.json           # Lockfile (auto-generated by npm install)
├── .dockerignore                   # MODIFY -- add site/ exclusion line
├── docker-compose.yaml             # EXISTING -- no changes
├── Makefile                        # EXISTING -- no changes
└── README.md                       # EXISTING -- optionally add landing page link
```

### Structure Rationale

- **`site/` at repo root:** Mirrors the existing convention of top-level directories for each concern (`docker/`, `helm/`, `k8s/`). The name `site/` clearly communicates "landing page" without ambiguity. The `withastro/action@v5` supports a `path` input for subdirectory projects, so this is the officially supported pattern.
- **Not `docs/`:** This is a marketing/landing page, not documentation. Using `docs/` would create confusion with potential future documentation (which GitHub Pages also conventionally serves from `docs/`).
- **Not a separate repo:** The landing page describes this product. Co-locating it keeps the site in sync with the product. A single repo means one place for issues, PRs, and deployment history.
- **Own `package.json` inside `site/`:** The rest of the repo has zero Node.js dependencies. Isolating Astro's dependency tree inside `site/` prevents polluting the repo root with `node_modules/`, `package-lock.json`, and Node.js config files that have nothing to do with the product.
- **No changes to Makefile or docker-compose.yaml:** The site uses `npm` scripts via the Astro CLI, a completely different toolchain. Adding Make targets for a Node.js build would be inconsistent with the existing Make conventions (which are all Docker/KIND/kubectl).

## Architectural Patterns

### Pattern 1: Complete Isolation Between Product and Site

**What:** The Astro site has zero code dependencies on the product. No shared files, no imports, no build coupling. They share a Git repository but nothing else.

**When to use:** Always, for this project type. The product is Dockerfiles, shell scripts, YAML manifests, and Helm charts. The site is a Node.js/Astro static page. Completely different toolchains with no intersection.

**Trade-offs:**
- Pro: Changing product code never breaks the site and vice versa
- Pro: Different CI pipelines run independently with zero wasted minutes
- Pro: Docker builds exclude site entirely via `.dockerignore`
- Con: Content on the landing page (features, install steps) must be manually kept in sync with README and product changes

### Pattern 2: Path-Filtered Separate Workflows

**What:** The existing `ci.yaml` and new `deploy-site.yaml` use path filters so each only triggers when its relevant files change. A site-only push does not trigger Docker builds. A Dockerfile-only push does not trigger site deploys.

**When to use:** Any repo with independent build targets that should not trigger each other's pipelines.

**Trade-offs:**
- Pro: No wasted CI minutes on unrelated builds
- Pro: Clear separation of concerns at the CI layer
- Con: Path filters do not apply to `workflow_dispatch` (manual triggers always run)
- Con: The initial push to a new branch evaluates all files, not just changed ones

**Implementation for ci.yaml (existing, add paths-ignore):**
```yaml
on:
  push:
    branches: ["*"]
    tags: ["v*"]
    paths-ignore:
      - 'site/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'site/**'
```

**Implementation for deploy-site.yaml (new, path filter):**
```yaml
on:
  push:
    branches: [main]
    paths:
      - 'site/**'
  workflow_dispatch:
```

### Pattern 3: withastro/action with `path` Parameter

**What:** The official `withastro/action@v5` has a `path` input that points to the Astro project root relative to the repository root. Set `path: ./site` and the action handles dependency installation, `astro build`, and artifact upload from that subdirectory automatically.

**When to use:** Any time the Astro project is not at the repo root. This is the officially supported approach from the Astro team.

**Trade-offs:**
- Pro: Zero custom build scripts. The action auto-detects the package manager from the lockfile
- Pro: Built-in build caching via the `cache` input (defaults to `true`)
- Pro: Maintained by the Astro team; updates track Astro releases
- Con: Slightly less control than a manual `npm ci && npm run build` step (though `build-cmd` input allows overrides)

**Configuration options (withastro/action@v5, v5.2.0):**

| Input | Default | Purpose |
|-------|---------|---------|
| `path` | `.` | Astro project root relative to repo root |
| `node-version` | `22` | Node.js version for the build |
| `package-manager` | auto-detected | npm, yarn, pnpm, bun, or deno |
| `build-cmd` | `<pm> run build` | Custom build command override |
| `cache` | `true` | Enable Astro build cache |
| `cache-dir` | `node_modules/.astro` | Cache directory path |
| `out-dir` | `dist` | Astro output directory |

## Data Flow

### Build and Deploy Flow (Landing Page)

```
Push to main (site/** files changed)
    |
    v
deploy-site.yaml triggers (path filter matches site/**)
    |
    v
actions/checkout@v4 -- clone full repo
    |
    v
withastro/action@v5 (path: ./site)
    |-- Detects package manager from site/package-lock.json
    |-- Runs npm ci in site/
    |-- Runs npm run build (astro build)
    |-- Uploads site/dist/ as pages artifact
    |
    v
actions/deploy-pages@v4
    |-- Deploys artifact to GitHub Pages
    |-- Environment: github-pages
    |
    v
GitHub Pages CDN serves at remotekube.patrykgolabek.dev
    (DNS CNAME -> <user>.github.io, CNAME file in artifact)
```

### Existing CI Flow (Product -- unchanged)

```
Push to any branch (non-site/** files changed)
    |
    v
ci.yaml triggers (paths-ignore: site/** skips site-only pushes)
    |
    +----> build-scan-publish (Docker build, Trivy scan, SBOM)
    +----> helm-lint (Helm lint, golden file test)
    +----> integration-tests (KIND cluster, BATS tests)
```

### Key Data Flows

1. **Site build:** `site/src/**` -> Astro compiler -> `site/dist/` -> GitHub Pages artifact -> CDN at `remotekube.patrykgolabek.dev`
2. **Product build:** `docker/Dockerfile` + repo context -> Docker image -> GHCR at `ghcr.io/<owner>/claude-in-a-box`
3. **No cross-flow:** Site build never touches Docker. Docker build never touches site (`.dockerignore` excludes `site/`). The two pipelines are completely independent.

## Integration Points

### New Files to Create

| File | Purpose |
|------|---------|
| `.github/workflows/deploy-site.yaml` | Astro build + GitHub Pages deployment workflow |
| `site/package.json` | Astro + Tailwind dependencies |
| `site/astro.config.mjs` | Site URL (`remotekube.patrykgolabek.dev`), Tailwind integration |
| `site/tailwind.config.mjs` | Tailwind CSS configuration |
| `site/tsconfig.json` | TypeScript config (extends Astro strict preset) |
| `site/public/CNAME` | Custom domain: `remotekube.patrykgolabek.dev` |
| `site/src/pages/index.astro` | Landing page entry point |
| `site/src/layouts/Base.astro` | HTML base layout with head, meta, OG tags |
| `site/src/components/Header.astro` | Navigation header |
| `site/src/components/Hero.astro` | Hero section |
| `site/src/components/Features.astro` | Feature highlights |
| `site/src/components/QuickStart.astro` | Getting started / installation |
| `site/src/components/Architecture.astro` | Architecture diagram section |
| `site/src/components/Footer.astro` | Footer with links |
| `site/src/styles/global.css` | Tailwind directives and global styles |
| `site/public/favicon.svg` | Favicon |

### Existing Files to Modify

| File | Change | Why |
|------|--------|-----|
| `.dockerignore` | Add `site/` line | Prevent `node_modules/` (hundreds of MB) from entering Docker build context |
| `.github/workflows/ci.yaml` | Add `paths-ignore: ['site/**']` to `push` and `pull_request` triggers | Prevent site-only changes from triggering Docker builds, Trivy scans, Helm lint, and integration tests |

### Files NOT to Modify

| File | Why Leave Alone |
|------|-----------------|
| `Makefile` | Site uses npm/Astro CLI, not Make. Different toolchain entirely. |
| `docker-compose.yaml` | Site is static HTML on GitHub Pages, not a Docker service. |
| `helm/` | Site is not deployed to Kubernetes. |
| `k8s/` | Site is not deployed to Kubernetes. |
| `tests/` | Site has no integration tests against KIND. Visual verification is sufficient for a landing page. |

### GitHub Repository Settings Required

Three manual configuration steps in the GitHub repository settings:

1. **Settings -> Pages -> Build and deployment -> Source:** Set to "GitHub Actions" (not "Deploy from a branch")
2. **Settings -> Pages -> Custom domain:** Enter `remotekube.patrykgolabek.dev`
3. **DNS provider:** Add a CNAME record: `remotekube.patrykgolabek.dev` -> `<username>.github.io`

### Complete deploy-site.yaml Workflow

```yaml
name: Deploy Landing Page

on:
  push:
    branches: [main]
    paths:
      - 'site/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Astro site
        uses: withastro/action@v5
        with:
          path: ./site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

### Astro Configuration

```javascript
// site/astro.config.mjs
import { defineConfig } from 'astro/config';
import tailwindcss from '@astrojs/tailwind';

export default defineConfig({
  site: 'https://remotekube.patrykgolabek.dev',
  integrations: [tailwindcss()],
});
```

### CNAME File

```
remotekube.patrykgolabek.dev
```

This file goes at `site/public/CNAME`. The `withastro/action` copies everything from `public/` into the build output, so the CNAME file ends up at the root of the deployed site, which is what GitHub Pages requires for custom domains.

## Anti-Patterns

### Anti-Pattern 1: Astro Project at Repo Root

**What people do:** Put `package.json`, `astro.config.mjs`, and `src/` at the repo root alongside `Makefile`, `docker/`, and `helm/`.

**Why it is wrong:** Pollutes the repo root with Node.js artifacts (`node_modules/`, `.astro/`, `package.json`, `package-lock.json`) that are completely unrelated to the product. Confuses contributors about what the project is. Risks `node_modules/` entering the Docker build context if `.dockerignore` has any gaps.

**Do this instead:** Isolate in `site/`. Use `withastro/action`'s `path: ./site` parameter.

### Anti-Pattern 2: Shared Workflow for Product CI and Site Deploy

**What people do:** Add Astro build steps to the existing `ci.yaml`, either as a new job or additional steps.

**Why it is wrong:** Every Dockerfile change triggers a site build. Every site text change triggers Docker builds, Trivy scans, and KIND cluster integration tests. Wastes CI minutes, creates false coupling, and makes CI results noisy.

**Do this instead:** Separate workflow files with path filters. `ci.yaml` uses `paths-ignore: ['site/**']`. `deploy-site.yaml` uses `paths: ['site/**']`.

### Anti-Pattern 3: Deploying the Landing Page via Docker/Kubernetes

**What people do:** Build the Astro output into a Docker image with nginx, deploy to the same Kubernetes cluster as the product.

**Why it is wrong:** Massive over-engineering for a static landing page. Adds infrastructure cost, operational complexity, TLS certificate management, and deployment coupling. GitHub Pages is free, globally distributed via CDN, and purpose-built for static sites.

**Do this instead:** GitHub Pages with `withastro/action`. Zero infrastructure to manage.

### Anti-Pattern 4: Forgetting .dockerignore Exclusion

**What people do:** Add `site/` directory but forget to exclude it from the Docker build context.

**Why it is wrong:** `node_modules/` (often 200+ MB) gets sent to the Docker daemon on every `docker build`. Dramatically slows product builds. Could end up in the image if the Dockerfile has a broad `COPY . .` statement.

**Do this instead:** Add `site/` to `.dockerignore` as the first step when creating the directory.

### Anti-Pattern 5: Using `base` Config with Custom Domain

**What people do:** Set both `site` and `base` in `astro.config.mjs` when using a custom domain.

**Why it is wrong:** The `base` option (e.g., `/my-repo`) is only needed when deploying to a subpath like `username.github.io/my-repo`. With a custom domain (`remotekube.patrykgolabek.dev`), the site is served from the root. Setting `base` would break all asset paths and internal links.

**Do this instead:** Set only `site: 'https://remotekube.patrykgolabek.dev'`. Do not set `base`.

## Build Order

Implementation order respecting file dependencies:

```
Phase 1: Foundation (no dependencies)
    ├── Create site/ directory
    ├── Create site/package.json (Astro + Tailwind deps)
    ├── Create site/astro.config.mjs (custom domain config)
    ├── Create site/tailwind.config.mjs
    ├── Create site/tsconfig.json
    ├── Create site/public/CNAME
    ├── Add site/ to .dockerignore
    └── Run npm install in site/ to generate lockfile

Phase 2: Layout and Styles (depends on Phase 1)
    ├── Create site/src/styles/global.css (Tailwind directives)
    └── Create site/src/layouts/Base.astro (HTML shell, imports global.css)

Phase 3: Components (depends on Phase 2)
    ├── Create Header.astro
    ├── Create Hero.astro
    ├── Create Features.astro
    ├── Create QuickStart.astro
    ├── Create Architecture.astro
    └── Create Footer.astro

Phase 4: Page Assembly (depends on Phase 3)
    └── Create site/src/pages/index.astro (imports layout + all components)

Phase 5: CI/CD Integration (depends on Phase 4)
    ├── Create .github/workflows/deploy-site.yaml
    ├── Add paths-ignore to .github/workflows/ci.yaml
    └── Configure GitHub repo settings (Pages source, custom domain, DNS)
```

**Phase ordering rationale:**
- Foundation first because `npm install` must succeed before any Astro file can be tested locally
- Layout before components because components render inside the layout
- Components before page because the page imports components
- CI/CD last because there is nothing to deploy until the page exists and builds successfully
- `.dockerignore` modification in Phase 1 to prevent any Docker build performance regression from the start

## Sources

- [Astro GitHub Pages deployment guide](https://docs.astro.build/en/guides/deploy/github/) -- official Astro docs, HIGH confidence
- [withastro/action v5](https://github.com/withastro/action) -- official GitHub Action, v5.2.0 (Feb 2026), HIGH confidence
- [Astro project structure](https://docs.astro.build/en/basics/project-structure/) -- official Astro docs, HIGH confidence
- [actions/deploy-pages](https://github.com/actions/deploy-pages) -- official GitHub Action, HIGH confidence
- [GitHub Pages custom domain configuration](https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site) -- official GitHub docs, HIGH confidence
- [GitHub Actions path filtering](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions) -- official GitHub docs, HIGH confidence
- [Monorepo Astro deployment patterns](https://devactivity.com/posts/development-integrations/mastering-monorepo-deployment-angular-astro-on-github-pages-for-enhanced-software-project-metrics/) -- community article, MEDIUM confidence

---
*Architecture research for: Astro landing page integration into claude-in-a-box repository*
*Researched: 2026-02-25*
