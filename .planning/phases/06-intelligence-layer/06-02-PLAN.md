---
phase: 06-intelligence-layer
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - scripts/generate-claude-md.sh
  - scripts/entrypoint.sh
  - docker/Dockerfile
autonomous: true
requirements: [DOC-02]

must_haves:
  truths:
    - "CLAUDE.md is auto-generated at container startup with cluster name, namespace, node count, and Kubernetes version"
    - "CLAUDE.md generation gracefully degrades in standalone mode (no ServiceAccount token)"
    - "Skills from /opt/claude-skills/ are copied to /app/.claude/skills/ on first start"
    - "Entrypoint calls generate-claude-md.sh and stages skills before Claude Code starts"
  artifacts:
    - path: "scripts/generate-claude-md.sh"
      provides: "Cluster context discovery and CLAUDE.md generation"
      contains: "kubernetes.default.svc"
    - path: "scripts/entrypoint.sh"
      provides: "Modified entrypoint with skills staging and CLAUDE.md generation"
      contains: "generate-claude-md"
    - path: "docker/Dockerfile"
      provides: "Updated Dockerfile that COPY's generate-claude-md.sh into image"
      contains: "generate-claude-md"
  key_links:
    - from: "scripts/entrypoint.sh"
      to: "scripts/generate-claude-md.sh"
      via: "Invocation before mode dispatch"
      pattern: "generate-claude-md"
    - from: "scripts/generate-claude-md.sh"
      to: "/var/run/secrets/kubernetes.io/serviceaccount/token"
      via: "ServiceAccount token for Kubernetes API queries"
      pattern: "serviceaccount/token"
    - from: "scripts/entrypoint.sh"
      to: "/opt/claude-skills/"
      via: "Stage-copy skills from build-time staging to PVC-mounted /app/.claude/skills/"
      pattern: "opt/claude-skills"
    - from: "docker/Dockerfile"
      to: "scripts/generate-claude-md.sh"
      via: "COPY to /usr/local/bin/"
      pattern: "COPY.*generate-claude-md"
---

<objective>
Create the CLAUDE.md auto-generation script and wire skills staging + context generation into the container entrypoint.

Purpose: This plan completes the intelligence layer wiring. The generate-claude-md.sh script queries the Kubernetes API at startup and writes a context-rich CLAUDE.md so Claude Code knows its cluster environment. The entrypoint is modified to (1) copy skills from the build-time staging location into the PVC-mounted directory, and (2) generate CLAUDE.md -- both before Claude Code starts.

Output: `scripts/generate-claude-md.sh` for cluster context discovery, modified `scripts/entrypoint.sh` with pre-exec setup, updated `docker/Dockerfile` with COPY for the new script.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-intelligence-layer/06-RESEARCH.md
@.planning/phases/06-intelligence-layer/06-01-SUMMARY.md

@docker/Dockerfile
@scripts/entrypoint.sh
@k8s/base/04-statefulset.yaml

<interfaces>
<!-- From 06-01: Skills staged at /opt/claude-skills/ in the Docker image -->
<!-- From 06-01: .mcp.json at /app/.mcp.json in the Docker image -->

From k8s/base/04-statefulset.yaml (PVC mount):
```yaml
volumeMounts:
  - name: claude-data
    mountPath: /app/.claude
```

From scripts/entrypoint.sh (current structure):
```bash
# Key insertion points:
# 1. After validate_auth (line 98)
# 2. Before mode dispatch (line 105)
# The new skills staging + CLAUDE.md generation goes between these two sections.
```

Kubernetes ServiceAccount token location (auto-mounted by default):
- Token: /var/run/secrets/kubernetes.io/serviceaccount/token
- CA cert: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
- Namespace: /var/run/secrets/kubernetes.io/serviceaccount/namespace
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generate-claude-md.sh script</name>
  <files>scripts/generate-claude-md.sh</files>
  <action>
Create `scripts/generate-claude-md.sh` -- a standalone shell script that queries the Kubernetes API and writes `/app/CLAUDE.md`.

Follow the research template from 06-RESEARCH.md with these specifics:

1. Set `set -euo pipefail` at the top.

2. Define constants:
   - `CLAUDE_MD_PATH="/app/CLAUDE.md"`
   - `SA_TOKEN_PATH="/var/run/secrets/kubernetes.io/serviceaccount/token"`
   - `SA_CA_PATH="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"`
   - `SA_NS_PATH="/var/run/secrets/kubernetes.io/serviceaccount/namespace"`
   - `K8S_API="https://kubernetes.default.svc"`

3. Create a `k8s_get()` helper function that curls the K8s API with the ServiceAccount token and CA cert. Use `--max-time 5` to avoid hanging if the API is slow. Return `{}` on failure.

4. **Standalone mode detection:** If `$SA_TOKEN_PATH` does not exist, write a minimal CLAUDE.md for standalone/Docker Compose mode:
   ```
   # Claude In A Box

   You are running in standalone mode (Docker Compose or local).
   No Kubernetes cluster access is available.

   ## Available Tools
   - Standard CLI tools: kubectl, helm, k9s, stern, kubectx, jq, yq, curl, dig, nmap, etc.
   - Run `verify-tools.sh` for the complete list.
   ```
   Then `exit 0` (not `exit 1` -- standalone is a valid configuration).

5. **Cluster context discovery:** Query 3 API endpoints:
   - `/version` -- extract `.gitVersion` via jq
   - `/api/v1/nodes` -- extract `.items | length` via jq for node count
   - Namespace from `$SA_NS_PATH` file
   - Pod name from `$HOSTNAME` env var
   - Cluster name from `$CLUSTER_NAME` env var, falling back to "unknown" (no standard K8s API for cluster name)

6. **Write CLAUDE.md** using heredoc to `/app/CLAUDE.md`. Include:
   - Header: "Claude In A Box - DevOps Agent"
   - Instruction: "You are a Kubernetes DevOps agent running inside the cluster. Use MCP tools for structured queries instead of shelling out to kubectl."
   - Cluster Environment section: K8s version, namespace, node count, pod name
   - Available MCP Tools section: kubernetes-mcp-server in read-only mode, list of accessible resource types (matching the ClusterRole from k8s/base/02-rbac-reader.yaml: pods, services, deployments, events, nodes, namespaces, configmaps, ingresses, PVCs, jobs, cronjobs, statefulsets, daemonsets, replicasets)
   - Available Skills section: pod-diagnosis, log-analysis, incident-triage, network-debugging with one-line descriptions
   - CLI Tools section: mention kubectl, helm, k9s, stern, and verify-tools.sh
   - Guidelines: prefer MCP over kubectl, check events with pod status, use skills for structured workflows, read-only access by default

7. Print a summary log line: `[claude-md] Generated CLAUDE.md: K8s {version}, {node_count} nodes, ns={namespace}`

The script must be idempotent -- it overwrites CLAUDE.md on every run (container restart gets fresh cluster info).
  </action>
  <verify>
    <automated>test -f scripts/generate-claude-md.sh && head -1 scripts/generate-claude-md.sh | grep -q "bash" && grep -q "kubernetes.default.svc" scripts/generate-claude-md.sh && grep -q "serviceaccount/token" scripts/generate-claude-md.sh && grep -q "CLAUDE.md" scripts/generate-claude-md.sh && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - scripts/generate-claude-md.sh exists with bash shebang
    - Script queries K8s API via ServiceAccount token for cluster version, node count, namespace
    - Script writes /app/CLAUDE.md with cluster context, MCP tools, skills, and CLI tools sections
    - Standalone mode produces a valid fallback CLAUDE.md (no error exit)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire skills staging and CLAUDE.md generation into entrypoint and Dockerfile</name>
  <files>
    scripts/entrypoint.sh
    docker/Dockerfile
  </files>
  <action>
Two files to modify:

**A. scripts/entrypoint.sh** -- Add two new sections between `validate_auth` (line 98) and the mode dispatch `case` (line 105):

Section 1: Skills staging (solves PVC overlay issue):
```bash
# =============================================================================
# Stage DevOps Skills into PVC
# Skills are baked into the image at /opt/claude-skills/ but the PVC mounted
# at /app/.claude/ overlays the container filesystem. Copy skills into the
# PVC-mounted directory if they are not already present.
# =============================================================================
if [ -d /opt/claude-skills ] && [ ! -d /app/.claude/skills ]; then
    echo "[entrypoint] Staging DevOps skills into PVC..."
    cp -r /opt/claude-skills /app/.claude/skills
    echo "[entrypoint] Skills staged: $(ls /app/.claude/skills/ 2>/dev/null | tr '\n' ' ')"
elif [ -d /app/.claude/skills ]; then
    echo "[entrypoint] Skills already present in PVC"
fi
```
Key design: Only copy if `/app/.claude/skills` does NOT exist. This preserves user modifications to skills in the PVC. If the user deletes the skills directory, the next restart will re-stage them from the image.

Section 2: CLAUDE.md generation:
```bash
# =============================================================================
# Generate CLAUDE.md with cluster context
# Must run before exec so Claude Code has context at startup.
# Failures are non-fatal (standalone mode has no K8s access).
# =============================================================================
echo "[entrypoint] Generating CLAUDE.md with cluster context..."
/usr/local/bin/generate-claude-md.sh || echo "[entrypoint] WARNING: CLAUDE.md generation failed (non-fatal)"
```
This calls the script created in Task 1. The `|| echo` ensures a generation failure does not prevent Claude Code from starting (non-fatal).

Both sections go AFTER `validate_auth` and BEFORE the mode dispatch comment block.

**B. docker/Dockerfile** -- Add one COPY block in the same area as the existing entrypoint COPY (after line 262, near the other script COPY commands):

```dockerfile
# -- Copy CLAUDE.md generation script -----------------------------------------
COPY --chown=agent:agent scripts/generate-claude-md.sh /usr/local/bin/generate-claude-md.sh
```

Also update the existing chmod RUN that makes entrypoint.sh, healthcheck.sh, and readiness.sh executable to ALSO include generate-claude-md.sh:
```dockerfile
RUN chmod +x /usr/local/bin/entrypoint.sh /usr/local/bin/healthcheck.sh /usr/local/bin/readiness.sh /usr/local/bin/generate-claude-md.sh
```

Do NOT create a separate RUN layer for chmod -- extend the existing one.
  </action>
  <verify>
    <automated>grep -q "generate-claude-md" scripts/entrypoint.sh && grep -q "opt/claude-skills" scripts/entrypoint.sh && grep -q "generate-claude-md" docker/Dockerfile && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - Entrypoint stages skills from /opt/claude-skills/ to /app/.claude/skills/ on first start
    - Entrypoint calls generate-claude-md.sh before mode dispatch (non-fatal on failure)
    - Dockerfile COPY's generate-claude-md.sh to /usr/local/bin/ and makes it executable
    - Skills staging only triggers when /app/.claude/skills/ does not exist (preserves user modifications)
  </done>
</task>

</tasks>

<verification>
1. `scripts/generate-claude-md.sh` exists and is a valid bash script
2. `scripts/entrypoint.sh` contains skills staging logic (checks /opt/claude-skills, copies to /app/.claude/skills/)
3. `scripts/entrypoint.sh` calls generate-claude-md.sh before mode dispatch
4. `docker/Dockerfile` COPY's generate-claude-md.sh and makes it executable
5. All modifications maintain the existing entrypoint structure (validate_mode -> validate_auth -> NEW SECTIONS -> mode dispatch)
</verification>

<success_criteria>
- DOC-02: generate-claude-md.sh queries K8s API for cluster version, namespace, node count and writes /app/CLAUDE.md
- DOC-02: Standalone mode (no ServiceAccount token) produces a valid fallback CLAUDE.md
- INT-02 wiring: Skills are copied from staging to PVC on first start, surviving the PVC overlay
- Entrypoint calls both skills staging and CLAUDE.md generation before exec-ing into Claude Code
</success_criteria>

<output>
After completion, create `.planning/phases/06-intelligence-layer/06-02-SUMMARY.md`
</output>
