---
phase: 06-intelligence-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .mcp.json
  - .claude/skills/pod-diagnosis/SKILL.md
  - .claude/skills/log-analysis/SKILL.md
  - .claude/skills/incident-triage/SKILL.md
  - .claude/skills/network-debugging/SKILL.md
  - docker/Dockerfile
autonomous: true
requirements: [INT-01, INT-02]

must_haves:
  truths:
    - "MCP server configuration exists at project root with read-only kubernetes access"
    - "Four DevOps skill files exist with focused descriptions for auto-loading"
    - "Dockerfile copies .mcp.json to /app/.mcp.json and skills to /opt/claude-skills/"
    - "Settings.json grants mcp__kubernetes__* permissions"
  artifacts:
    - path: ".mcp.json"
      provides: "MCP server registration for kubernetes-mcp-server"
      contains: "kubernetes-mcp-server"
    - path: ".claude/skills/pod-diagnosis/SKILL.md"
      provides: "Pod diagnosis skill"
      contains: "pod-diagnosis"
    - path: ".claude/skills/log-analysis/SKILL.md"
      provides: "Log analysis skill"
      contains: "log-analysis"
    - path: ".claude/skills/incident-triage/SKILL.md"
      provides: "Incident triage skill"
      contains: "incident-triage"
    - path: ".claude/skills/network-debugging/SKILL.md"
      provides: "Network debugging skill"
      contains: "network-debugging"
    - path: "docker/Dockerfile"
      provides: "Updated image with MCP config, skills staging, and MCP permissions"
      contains: "mcp__kubernetes__"
  key_links:
    - from: ".mcp.json"
      to: "kubernetes-mcp-server binary"
      via: "npx invocation with --read-only --cluster-provider in-cluster"
      pattern: "kubernetes-mcp-server.*--read-only.*--cluster-provider.*in-cluster"
    - from: "docker/Dockerfile"
      to: ".mcp.json"
      via: "COPY to /app/.mcp.json"
      pattern: "COPY.*\\.mcp\\.json.*/app/"
    - from: "docker/Dockerfile"
      to: ".claude/skills/"
      via: "COPY to /opt/claude-skills/ (staging location, NOT /app/.claude/skills/ which PVC overlays)"
      pattern: "COPY.*skills.*opt/claude-skills"
    - from: "docker/Dockerfile"
      to: "settings.json"
      via: "mcp__kubernetes__* in permissions allow list"
      pattern: "mcp__kubernetes__"
---

<objective>
Create MCP server configuration, DevOps skills library, and update Dockerfile to include them in the container image.

Purpose: This plan delivers the intelligence layer content -- the MCP config that gives Claude Code structured Kubernetes API access and the four DevOps skills that guide Claude through common debugging workflows. The Dockerfile is updated to bake these into the image at build time.

Output: `.mcp.json` at project root, 4 SKILL.md files under `.claude/skills/`, updated Dockerfile with MCP config COPY, skills staging COPY, and MCP permission grants.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-intelligence-layer/06-RESEARCH.md

@docker/Dockerfile
@scripts/entrypoint.sh
@k8s/base/04-statefulset.yaml

<interfaces>
<!-- Key context from existing codebase -->

From docker/Dockerfile (settings.json section, lines 228-245):
```json
{
  "permissions": {
    "allow": [
      "Bash",
      "Read",
      "Edit",
      "Write"
    ],
    "defaultMode": "bypassPermissions"
  },
  "env": {
    "DISABLE_AUTOUPDATER": "1",
    "DISABLE_TELEMETRY": "1",
    "DISABLE_ERROR_REPORTING": "1"
  }
}
```

From k8s/base/04-statefulset.yaml (PVC mount, lines 55-57):
```yaml
volumeMounts:
  - name: claude-data
    mountPath: /app/.claude
```
CRITICAL: The PVC mounts at /app/.claude, which overlays the container's /app/.claude/ directory.
Skills COPY'd to /app/.claude/skills/ in the Dockerfile will be HIDDEN by this PVC mount.
Solution: COPY skills to /opt/claude-skills/ (staging location), then entrypoint copies them
into the PVC-mounted /app/.claude/skills/ on first start (handled in Plan 06-02).
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP config and DevOps skills library</name>
  <files>
    .mcp.json
    .claude/skills/pod-diagnosis/SKILL.md
    .claude/skills/log-analysis/SKILL.md
    .claude/skills/incident-triage/SKILL.md
    .claude/skills/network-debugging/SKILL.md
  </files>
  <action>
Create 5 files:

1. `.mcp.json` at project root -- MCP server registration for kubernetes-mcp-server:
```json
{
  "mcpServers": {
    "kubernetes": {
      "type": "stdio",
      "command": "npx",
      "args": [
        "-y",
        "kubernetes-mcp-server@latest",
        "--read-only",
        "--cluster-provider", "in-cluster"
      ],
      "env": {}
    }
  }
}
```
Use npx (not a direct binary path) because the npm package `kubernetes-mcp-server` may be a Node.js wrapper around the Go binary. The `--read-only` flag exposes only read-annotated tools. The `--cluster-provider in-cluster` uses the ServiceAccount token auto-mounted at `/var/run/secrets/kubernetes.io/serviceaccount/`.

2. `.claude/skills/pod-diagnosis/SKILL.md` -- Pod health diagnosis workflow:
   - YAML frontmatter with `name: pod-diagnosis` and description mentioning CrashLoopBackOff, ImagePullBackOff, OOMKilled, pending pods, readiness failures
   - Structured workflow: get pod status, check events, read logs (current + previous), inspect describe, check related resources
   - Common failure patterns table: symptom, likely cause, investigation steps
   - Reference MCP kubernetes tools for structured queries, kubectl for complex operations

3. `.claude/skills/log-analysis/SKILL.md` -- Container log analysis:
   - YAML frontmatter with `name: log-analysis` and description mentioning error investigation, crash causes, performance issues
   - Workflow: identify target pods, fetch recent logs, check previous container, pattern recognition (ERROR/FATAL/PANIC, stack traces, resource messages)
   - Output format template: summary, evidence (specific log lines), timeline, recommendation

4. `.claude/skills/incident-triage/SKILL.md` -- Incident response workflow:
   - YAML frontmatter with `name: incident-triage` and description mentioning cluster incidents, outages, degraded services
   - Workflow: assess scope (how many pods/services affected), check cluster health (nodes, resource pressure), identify root cause (recent changes, events timeline), document findings
   - Severity classification: P1 (cluster-wide), P2 (namespace/service), P3 (single pod), P4 (informational)
   - Escalation criteria: when to involve human operator

5. `.claude/skills/network-debugging/SKILL.md` -- Network connectivity debugging:
   - YAML frontmatter with `name: network-debugging` and description mentioning DNS, connectivity, service mesh, ingress issues
   - Workflow: verify DNS resolution, test service connectivity, check NetworkPolicy, inspect ingress/service endpoints
   - Common issues table: DNS failures, service unreachable, connection timeouts, TLS errors
   - Tools reference: dig, nmap, curl, kubectl port-forward, MCP tools for services/endpoints

Keep each SKILL.md under 100 lines. Descriptions should be keyword-rich for Claude Code's auto-loading (it matches user queries against skill descriptions).

Do NOT use the `.claude/commands/` directory (deprecated, superseded by skills).
  </action>
  <verify>
    <automated>test -f .mcp.json && test -f .claude/skills/pod-diagnosis/SKILL.md && test -f .claude/skills/log-analysis/SKILL.md && test -f .claude/skills/incident-triage/SKILL.md && test -f .claude/skills/network-debugging/SKILL.md && grep -q "kubernetes-mcp-server" .mcp.json && grep -q "read-only" .mcp.json && echo "PASS: All 5 files exist with correct content" || echo "FAIL"</automated>
  </verify>
  <done>
    - .mcp.json exists at project root with kubernetes server config using --read-only and --cluster-provider in-cluster
    - 4 SKILL.md files exist under .claude/skills/ with YAML frontmatter and focused descriptions
    - Each skill covers one domain: pod-diagnosis, log-analysis, incident-triage, network-debugging
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Dockerfile with MCP config, skills staging, and permissions</name>
  <files>docker/Dockerfile</files>
  <action>
Modify docker/Dockerfile to add three sections AFTER the existing "Copy entrypoint and health check scripts" block (around line 265) but BEFORE the HEALTHCHECK directive:

1. **COPY .mcp.json to /app/.mcp.json:**
```dockerfile
# -- Copy MCP server configuration (project scope) ----------------------------
COPY --chown=agent:agent .mcp.json /app/.mcp.json
```
This must be at /app/.mcp.json because Claude Code's WORKDIR is /app and it reads .mcp.json from the project root (cwd).

2. **COPY skills to staging location /opt/claude-skills/ (NOT /app/.claude/skills/):**
```dockerfile
# -- Copy DevOps skills to staging location -----------------------------------
# Skills are staged in /opt/claude-skills/ because the PVC mounts at /app/.claude/
# and would overlay any files COPY'd into /app/.claude/skills/ at build time.
# The entrypoint copies them from staging into the PVC on first start.
COPY --chown=agent:agent .claude/skills/ /opt/claude-skills/
```
CRITICAL: Do NOT copy to /app/.claude/skills/. The PVC mounted at /app/.claude/ in the StatefulSet (k8s/base/04-statefulset.yaml line 57) overlays the entire /app/.claude/ directory. The /opt/claude-skills/ path is outside the PVC mount and survives.

Note: The COPY line needs to run as root (before USER agent) OR the /opt/claude-skills/ directory needs proper ownership. Since USER agent is already set earlier, add a line to create the directory. Actually, COPY --chown=agent:agent will handle ownership but /opt/ is owned by root. Two options:
- Switch to root temporarily: not ideal
- Better: Just use COPY --chown=agent:agent and Docker will create /opt/claude-skills/ owned by agent

Actually, Docker's COPY creates intermediate directories as needed and --chown sets ownership. This should work as-is since the agent user can write to /opt/ via COPY (COPY runs with build privileges, --chown just sets final ownership).

3. **Update settings.json to add MCP permission:**
Modify the existing `RUN cat > /app/.claude/settings.json` block (around line 228) to add `"mcp__kubernetes__*"` to the permissions allow list:
```json
{
  "permissions": {
    "allow": [
      "Bash",
      "Read",
      "Edit",
      "Write",
      "mcp__kubernetes__*"
    ],
    "defaultMode": "bypassPermissions"
  },
  "env": {
    "DISABLE_AUTOUPDATER": "1",
    "DISABLE_TELEMETRY": "1",
    "DISABLE_ERROR_REPORTING": "1"
  }
}
```
This auto-allows all MCP tools from the "kubernetes" server (the name matches the key in .mcp.json). Without this, Claude Code would prompt for permission on each MCP tool call.

Do NOT add a `RUN npm install -g kubernetes-mcp-server` step. The research notes this might be just a Node.js wrapper, and npx with -y flag works reliably. Pre-installation optimization can be done in Phase 7 (Production Packaging) after validating the current approach works.
  </action>
  <verify>
    <automated>grep -q "mcp__kubernetes__" docker/Dockerfile && grep -q "opt/claude-skills" docker/Dockerfile && grep -q ".mcp.json" docker/Dockerfile && echo "PASS: Dockerfile has MCP config, skills staging, and permissions" || echo "FAIL"</automated>
  </verify>
  <done>
    - Dockerfile COPY's .mcp.json to /app/.mcp.json
    - Dockerfile COPY's skills to /opt/claude-skills/ (staging, not PVC-mounted path)
    - settings.json in Dockerfile includes mcp__kubernetes__* in allow list
    - No new RUN layers for MCP server installation (deferred to Phase 7 optimization)
  </done>
</task>

</tasks>

<verification>
1. `.mcp.json` exists at project root and contains `kubernetes-mcp-server`, `--read-only`, and `--cluster-provider in-cluster`
2. All 4 SKILL.md files exist with YAML frontmatter containing `name:` and `description:` fields
3. Dockerfile contains COPY lines for .mcp.json and skills staging
4. Dockerfile settings.json includes `mcp__kubernetes__*` in permissions
5. Skills are staged to /opt/claude-skills/, NOT to /app/.claude/skills/
</verification>

<success_criteria>
- INT-01: .mcp.json pre-wires kubernetes-mcp-server with --read-only and --cluster-provider in-cluster
- INT-02: 4 skill SKILL.md files cover pod diagnosis, log analysis, incident triage, and network debugging
- Dockerfile bakes all intelligence layer content into the image with correct staging for PVC overlay
</success_criteria>

<output>
After completion, create `.planning/phases/06-intelligence-layer/06-01-SUMMARY.md`
</output>
