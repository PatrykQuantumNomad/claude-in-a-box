---
phase: 07-production-packaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - helm/claude-in-a-box/Chart.yaml
  - helm/claude-in-a-box/values.yaml
  - helm/claude-in-a-box/values-readonly.yaml
  - helm/claude-in-a-box/values-operator.yaml
  - helm/claude-in-a-box/values-airgapped.yaml
  - helm/claude-in-a-box/templates/_helpers.tpl
  - helm/claude-in-a-box/templates/serviceaccount.yaml
  - helm/claude-in-a-box/templates/clusterrole-reader.yaml
  - helm/claude-in-a-box/templates/clusterrolebinding-reader.yaml
  - helm/claude-in-a-box/templates/networkpolicy.yaml
  - helm/claude-in-a-box/templates/service.yaml
  - helm/claude-in-a-box/templates/statefulset.yaml
  - helm/claude-in-a-box/templates/clusterrole-operator.yaml
  - helm/claude-in-a-box/templates/clusterrolebinding-operator.yaml
  - helm/claude-in-a-box/templates/NOTES.txt
  - scripts/helm-golden-test.sh
  - helm/claude-in-a-box/tests/golden/values.golden.yaml
  - helm/claude-in-a-box/tests/golden/values-readonly.golden.yaml
  - helm/claude-in-a-box/tests/golden/values-operator.golden.yaml
  - helm/claude-in-a-box/tests/golden/values-airgapped.golden.yaml
autonomous: true

must_haves:
  truths:
    - "`helm install claude-agent ./helm/claude-in-a-box` deploys a working instance using default values"
    - "Three security profile values files produce correct RBAC and NetworkPolicy configurations"
    - "`helm template` output matches the validated raw manifests structurally (Helm wraps, not rewrites)"
    - "values-operator.yaml enables operator ClusterRole+ClusterRoleBinding; values-readonly.yaml disables them"
    - "values-airgapped.yaml disables HTTPS egress and restricts K8s API CIDR"
  artifacts:
    - path: "helm/claude-in-a-box/Chart.yaml"
      provides: "Helm chart metadata (apiVersion v2)"
      contains: "apiVersion: v2"
    - path: "helm/claude-in-a-box/values.yaml"
      provides: "Default values matching raw manifest defaults"
      contains: "operator:"
    - path: "helm/claude-in-a-box/templates/statefulset.yaml"
      provides: "Parameterized StatefulSet template"
      contains: ".Values.image.repository"
    - path: "helm/claude-in-a-box/templates/networkpolicy.yaml"
      provides: "Conditional NetworkPolicy with egress toggles"
      contains: ".Values.networkPolicy.egress"
    - path: "scripts/helm-golden-test.sh"
      provides: "Golden file validation script"
      contains: "helm template"
  key_links:
    - from: "helm/claude-in-a-box/templates/statefulset.yaml"
      to: "helm/claude-in-a-box/values.yaml"
      via: "Values references (.Values.image, .Values.resources, etc.)"
      pattern: "\\.Values\\."
    - from: "helm/claude-in-a-box/templates/clusterrole-operator.yaml"
      to: "helm/claude-in-a-box/values.yaml"
      via: "Conditional rendering on operator.enabled"
      pattern: "if .Values.operator.enabled"
    - from: "helm/claude-in-a-box/templates/clusterrolebinding-reader.yaml"
      to: "helm/claude-in-a-box/templates/_helpers.tpl"
      via: "ServiceAccount name and namespace via helpers"
      pattern: "claude-in-a-box.serviceAccountName"
---

<objective>
Create the Helm chart at `helm/claude-in-a-box/` that wraps the existing raw Kubernetes manifests from `k8s/base/` and `k8s/overlays/` into parameterized templates, provide three security profile values files, and validate with golden file diff tests.

Purpose: Enables parameterized deployment into any production cluster via `helm install claude-agent ./helm/claude-in-a-box`. The chart must wrap, not rewrite -- `helm template` output must structurally match the validated raw manifests.
Output: Complete Helm chart with Chart.yaml, values files, templates, golden files, and test script.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-production-packaging/07-RESEARCH.md

# Raw manifests that templates must wrap:
@k8s/base/01-serviceaccount.yaml
@k8s/base/02-rbac-reader.yaml
@k8s/base/03-networkpolicy.yaml
@k8s/base/04-statefulset.yaml
@k8s/overlays/rbac-operator.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Helm chart skeleton, values files, and all templates</name>
  <files>
    helm/claude-in-a-box/Chart.yaml
    helm/claude-in-a-box/values.yaml
    helm/claude-in-a-box/values-readonly.yaml
    helm/claude-in-a-box/values-operator.yaml
    helm/claude-in-a-box/values-airgapped.yaml
    helm/claude-in-a-box/templates/_helpers.tpl
    helm/claude-in-a-box/templates/serviceaccount.yaml
    helm/claude-in-a-box/templates/clusterrole-reader.yaml
    helm/claude-in-a-box/templates/clusterrolebinding-reader.yaml
    helm/claude-in-a-box/templates/networkpolicy.yaml
    helm/claude-in-a-box/templates/service.yaml
    helm/claude-in-a-box/templates/statefulset.yaml
    helm/claude-in-a-box/templates/clusterrole-operator.yaml
    helm/claude-in-a-box/templates/clusterrolebinding-operator.yaml
    helm/claude-in-a-box/templates/NOTES.txt
  </files>
  <action>
    Create the Helm chart directory structure and all files. Follow the research document exactly.

    **Chart.yaml:**
    - `apiVersion: v2` (NOT v3 -- v3 is a proposal, not released)
    - `name: claude-in-a-box`, `type: application`, `version: 0.1.0`, `appVersion: "dev"`

    **values.yaml (Default = Readonly profile):**
    - Use the exact values.yaml from the research document. Key settings:
      - `fullnameOverride: "claude-agent"` -- forces resource names to match raw manifests regardless of release name. This is critical for success criterion 4 and for `helm install claude-agent` to produce `claude-agent` named resources.
      - `operator.enabled: false` (default is readonly)
      - `networkPolicy.enabled: true` with egress DNS, HTTPS (0.0.0.0/0), K8s API (0.0.0.0/0)
      - `podSecurityContext` matching raw manifest: runAsUser 10000, runAsGroup 10000, fsGroup 10000
      - `resources` matching raw manifest: 512Mi/250m requests, 2Gi/2000m limits
      - `persistence.size: "1Gi"`, `accessMode: ReadWriteOnce`
      - `image.repository: claude-in-a-box`, `image.tag: "dev"`, `pullPolicy: IfNotPresent`
      - `claudeMode: "interactive"`

    **values-readonly.yaml (overlay -- minimal):**
    - Comment header explaining this is an explicit readonly profile overlay
    - Can be empty or have a single comment, since readonly IS the default in values.yaml
    - Include `operator: enabled: false` for explicitness, plus a comment noting it matches defaults

    **values-operator.yaml (overlay -- minimal):**
    - Only: `operator: enabled: true`
    - Comment header: "Operator security profile. Adds mutation permissions."
    - Usage comment: `helm install claude-agent ./helm/claude-in-a-box -f helm/claude-in-a-box/values-operator.yaml`

    **values-airgapped.yaml (overlay -- minimal):**
    - `image.repository: "internal-registry.corp/claude-in-a-box"`, `image.pullPolicy: IfNotPresent`
    - `networkPolicy.egress.https.enabled: false`
    - `networkPolicy.egress.k8sApi.cidr: "10.96.0.1/32"`
    - Comment header explaining airgapped restrictions

    **_helpers.tpl:**
    - Use the exact _helpers.tpl from the research document
    - Defines: claude-in-a-box.name, claude-in-a-box.fullname, claude-in-a-box.labels, claude-in-a-box.selectorLabels, claude-in-a-box.chart, claude-in-a-box.serviceAccountName

    **Templates -- CRITICAL: Wrap, don't rewrite:**
    Each template converts the corresponding raw manifest by replacing only hardcoded values with Helm references. Preserve field ordering, comments as templates, and structure.

    - **serviceaccount.yaml**: From k8s/base/01-serviceaccount.yaml. Replace name with `{{ include "claude-in-a-box.fullname" . }}`, namespace with `{{ .Release.Namespace }}`, add labels from helper. Keep `automountServiceAccountToken: {{ .Values.serviceAccount.automountServiceAccountToken }}`. Wrap in `{{- if .Values.serviceAccount.create }}`.

    - **clusterrole-reader.yaml**: From k8s/base/02-rbac-reader.yaml (ClusterRole part). Replace name with `{{ include "claude-in-a-box.fullname" . }}-reader`. Add labels from helper plus `tier: reader`. Keep rules exactly as-is (they don't vary).

    - **clusterrolebinding-reader.yaml**: From k8s/base/02-rbac-reader.yaml (ClusterRoleBinding part). Replace name with `{{ include "claude-in-a-box.fullname" . }}-reader`. roleRef.name matches the reader ClusterRole name. subjects.name uses `{{ include "claude-in-a-box.serviceAccountName" . }}`, subjects.namespace uses `{{ .Release.Namespace }}`.

    - **networkpolicy.yaml**: From k8s/base/03-networkpolicy.yaml. Conditional on `{{- if .Values.networkPolicy.enabled }}`. Name: `{{ include "claude-in-a-box.fullname" . }}-netpol`. Each egress rule conditional on its `.enabled` flag. CIDR values from `.Values.networkPolicy.egress.*.cidr`.

    - **service.yaml**: From k8s/base/04-statefulset.yaml (Service part only). Name: `{{ include "claude-in-a-box.fullname" . }}`. Keep clusterIP: None, placeholder port.

    - **statefulset.yaml**: From k8s/base/04-statefulset.yaml (StatefulSet part only). Replace: name, serviceName, replicas, image, imagePullPolicy, env CLAUDE_MODE value, securityContext, resources, probes, terminationGracePeriodSeconds, PVC spec. Keep stdin: true, tty: true, volumeMounts.

    - **clusterrole-operator.yaml**: From k8s/overlays/rbac-operator.yaml (ClusterRole). Wrap in `{{- if .Values.operator.enabled }}`. Name: `{{ include "claude-in-a-box.fullname" . }}-operator`. Keep rules exactly as-is.

    - **clusterrolebinding-operator.yaml**: From k8s/overlays/rbac-operator.yaml (ClusterRoleBinding). Wrap in `{{- if .Values.operator.enabled }}`. Name: `{{ include "claude-in-a-box.fullname" . }}-operator`. subjects.name from serviceAccountName helper, subjects.namespace from Release.Namespace.

    **NOTES.txt:**
    - Post-install instructions: how to check pod status, attach to Claude session, enable operator RBAC
    - Include `kubectl get pods -l app={{ include "claude-in-a-box.name" . }}` examples
  </action>
  <verify>
    Run `helm lint helm/claude-in-a-box --strict` and confirm zero errors/warnings.
    Run `helm template test-release helm/claude-in-a-box` and confirm it produces valid YAML with all expected resources (ServiceAccount, ClusterRole, ClusterRoleBinding, NetworkPolicy, Service, StatefulSet).
    Run `helm template test-release helm/claude-in-a-box -f helm/claude-in-a-box/values-operator.yaml` and confirm operator ClusterRole and ClusterRoleBinding appear in output.
    Run `helm template test-release helm/claude-in-a-box -f helm/claude-in-a-box/values-airgapped.yaml` and confirm HTTPS egress rule is absent and K8s API CIDR is 10.96.0.1/32.
  </verify>
  <done>
    All 4 `helm template` renders produce correct output: default has 7 resources (SA, CR-reader, CRB-reader, NetPol, Svc, STS -- no operator); operator adds 2 (CR-operator, CRB-operator); airgapped removes HTTPS egress and restricts K8s API CIDR; readonly matches default. `helm lint --strict` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create golden file test script and generate golden files</name>
  <files>
    scripts/helm-golden-test.sh
    helm/claude-in-a-box/tests/golden/values.golden.yaml
    helm/claude-in-a-box/tests/golden/values-readonly.golden.yaml
    helm/claude-in-a-box/tests/golden/values-operator.golden.yaml
    helm/claude-in-a-box/tests/golden/values-airgapped.golden.yaml
  </files>
  <action>
    **scripts/helm-golden-test.sh:**
    Create the golden file test script following the research pattern. The script:
    1. Iterates over values.yaml and each values-*.yaml file in the chart directory
    2. Runs `helm template test-release helm/claude-in-a-box -f <values-file>` for each
    3. For the default values.yaml, runs `helm template test-release helm/claude-in-a-box` (no -f, uses built-in values.yaml)
    4. Compares output against `helm/claude-in-a-box/tests/golden/<basename>.golden.yaml`
    5. Supports `--update` flag to regenerate golden files
    6. Exits non-zero on first mismatch, printing the diff
    7. Prints PASS/FAIL per values file

    Make executable: `chmod +x scripts/helm-golden-test.sh`

    **Generate golden files:**
    Run the script with `--update` flag to produce the initial golden files:
    - `values.golden.yaml` -- default values (helm template with no -f)
    - `values-readonly.golden.yaml` -- readonly profile
    - `values-operator.golden.yaml` -- operator profile (includes operator ClusterRole/Binding)
    - `values-airgapped.golden.yaml` -- airgapped profile (no HTTPS egress, restricted API CIDR)

    **Structural comparison (bonus validation):**
    After generating golden files, do a quick sanity check: compare the default golden file against the raw manifests from k8s/base/ to confirm structural equivalence. The template output will have Helm metadata (labels like `helm.sh/chart`, `app.kubernetes.io/managed-by: Helm`, `# Source:` comments) that the raw manifests don't -- this is expected. The resource specs (rules, ports, containers, securityContext) must match.
  </action>
  <verify>
    Run `bash scripts/helm-golden-test.sh` and confirm all 4 golden files pass (PASS: values, PASS: values-readonly, PASS: values-operator, PASS: values-airgapped).
    Run `bash scripts/helm-golden-test.sh --update` followed by `bash scripts/helm-golden-test.sh` to confirm idempotency.
    Verify golden files exist and are non-empty in helm/claude-in-a-box/tests/golden/.
  </verify>
  <done>
    Golden file test script exists at scripts/helm-golden-test.sh, is executable, and passes for all 4 values files. Golden files are committed and match current template output.
  </done>
</task>

</tasks>

<verification>
1. `helm lint helm/claude-in-a-box --strict` -- zero errors
2. `helm template test-release helm/claude-in-a-box` -- produces 7 valid K8s resources
3. `helm template test-release helm/claude-in-a-box -f helm/claude-in-a-box/values-operator.yaml` -- produces 9 resources (adds operator CR+CRB)
4. `helm template test-release helm/claude-in-a-box -f helm/claude-in-a-box/values-airgapped.yaml` -- HTTPS egress absent, K8s API CIDR restricted
5. `bash scripts/helm-golden-test.sh` -- all 4 pass
6. Resource names in default template output all start with `claude-agent` (matching raw manifests via fullnameOverride)
</verification>

<success_criteria>
- Helm chart at helm/claude-in-a-box/ with apiVersion v2, lints clean
- Default values produce resources matching raw k8s/base/ manifests structurally
- Operator values add mutation RBAC; airgapped values restrict network egress
- Golden file tests pass for all 4 security profiles
- All resource names use `claude-agent` prefix (via fullnameOverride) matching raw manifests
</success_criteria>

<output>
After completion, create `.planning/phases/07-production-packaging/07-01-SUMMARY.md`
</output>
