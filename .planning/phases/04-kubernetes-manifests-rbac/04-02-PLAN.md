---
phase: 04-kubernetes-manifests-rbac
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - k8s/overlays/rbac-operator.yaml
  - Makefile
autonomous: true
requirements: [K8S-05]

must_haves:
  truths:
    - "Operator-tier ClusterRole exists as a separate opt-in file not applied by default kubectl apply -f k8s/base/"
    - "Operator ClusterRole adds delete pods, create pods/exec, and update/patch deployments and statefulsets"
    - "Applying operator overlay adds permissions without removing reader permissions (RBAC is additive)"
    - "make deploy applies base manifests and waits for pod Ready"
    - "make deploy-operator applies operator RBAC separately"
    - "make bootstrap uses new k8s/base/ manifests instead of kind/pod.yaml"
  artifacts:
    - path: "k8s/overlays/rbac-operator.yaml"
      provides: "Operator-tier ClusterRole + ClusterRoleBinding (opt-in)"
      contains: "claude-agent-operator"
    - path: "Makefile"
      provides: "Updated targets for k8s/base/ manifests and operator overlay"
      contains: "K8S_MANIFESTS"
  key_links:
    - from: "k8s/overlays/rbac-operator.yaml"
      to: "k8s/base/01-serviceaccount.yaml"
      via: "ClusterRoleBinding subjects referencing same ServiceAccount"
      pattern: "name: claude-agent"
    - from: "Makefile"
      to: "k8s/base/"
      via: "K8S_MANIFESTS variable pointing to manifest directory"
      pattern: "K8S_MANIFESTS.*k8s/base"
    - from: "Makefile"
      to: "k8s/overlays/rbac-operator.yaml"
      via: "OPERATOR_RBAC variable for deploy-operator target"
      pattern: "OPERATOR_RBAC.*k8s/overlays"
---

<objective>
Create the operator-tier RBAC overlay (opt-in elevated permissions) and update the Makefile to deploy the full Phase 4 manifest set instead of the Phase 3 bare Pod.

Purpose: Completes the tiered RBAC model (reader default + operator opt-in) and integrates the new manifests into the developer workflow so `make bootstrap` and `make deploy` use the production manifest set.
Output: Operator RBAC overlay in k8s/overlays/ and updated Makefile with new deploy targets.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-kubernetes-manifests-rbac/04-RESEARCH.md
@Makefile
</context>

<interfaces>
<!-- From Plan 01 outputs (k8s/base/ manifests) -->

From k8s/base/01-serviceaccount.yaml (created by Plan 01):
```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: claude-agent
  namespace: default
  labels:
    app: claude-agent
```

From k8s/base/02-rbac-reader.yaml (created by Plan 01):
```yaml
# ClusterRole claude-agent-reader with get/list/watch on 14 resources
# ClusterRoleBinding claude-agent-reader binding to SA claude-agent in default namespace
```

From existing Makefile:
```makefile
IMAGE_NAME    ?= claude-in-a-box
IMAGE_TAG     ?= dev
CLUSTER_NAME  ?= claude-in-a-box
NAMESPACE     ?= default
KIND_CONFIG   ?= kind/cluster.yaml
POD_MANIFEST  ?= kind/pod.yaml

# Targets: help, build, load, deploy, bootstrap, teardown, redeploy, status
# deploy: kubectl apply -f $(POD_MANIFEST) + wait
# bootstrap: build + cluster create + load + deploy
# redeploy: build + load + delete pod + apply + wait
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create operator-tier RBAC overlay</name>
  <files>k8s/overlays/rbac-operator.yaml</files>
  <action>
Create the k8s/overlays/ directory.

**k8s/overlays/rbac-operator.yaml:**
Create a multi-document YAML file (separated by `---`) containing:

1. ClusterRole `claude-agent-operator` with labels `app: claude-agent` and `tier: operator`. Three rules:
   - apiGroups: [""] resources: ["pods"] verbs: ["delete"] -- for pod restarts
   - apiGroups: [""] resources: ["pods/exec"] verbs: ["create"] -- for kubectl exec
   - apiGroups: ["apps"] resources: ["deployments", "statefulsets"] verbs: ["update", "patch"] -- for rollout restarts

2. ClusterRoleBinding `claude-agent-operator` binding the ClusterRole to ServiceAccount `claude-agent` in namespace `default`.

Add a header comment explaining:
- This file is NOT applied by default
- Users apply it manually for elevated debugging permissions: `kubectl apply -f k8s/overlays/rbac-operator.yaml`
- RBAC is additive: this adds to (never replaces) the reader permissions
- To revoke: `kubectl delete -f k8s/overlays/rbac-operator.yaml`

IMPORTANT: This file lives in k8s/overlays/ (not k8s/base/) so that `kubectl apply -f k8s/base/` does NOT include it. kubectl does not recurse into subdirectories by default -- this is the intended isolation mechanism.
  </action>
  <verify>
    File exists: ls k8s/overlays/rbac-operator.yaml
    YAML valid: kubectl apply --dry-run=client -f k8s/overlays/rbac-operator.yaml
    Contains operator ClusterRole: grep "claude-agent-operator" k8s/overlays/rbac-operator.yaml
    Has delete verb: grep "delete" k8s/overlays/rbac-operator.yaml
    Has pods/exec: grep "pods/exec" k8s/overlays/rbac-operator.yaml
    Has update/patch: grep -E "update|patch" k8s/overlays/rbac-operator.yaml
    Not in base dir: test ! -f k8s/base/rbac-operator.yaml
  </verify>
  <done>
    Operator-tier RBAC overlay exists at k8s/overlays/rbac-operator.yaml, passes dry-run validation, contains ClusterRole with delete pods, create pods/exec, and update/patch deployments+statefulsets. File is NOT in k8s/base/ ensuring it is not applied by default.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Makefile for Phase 4 manifest deployment</name>
  <files>Makefile</files>
  <action>
Update the existing Makefile to use the new k8s/base/ manifests instead of the bare Pod manifest. Changes:

1. **Add new variables** (keep existing POD_MANIFEST for backward compat):
   ```makefile
   K8S_MANIFESTS ?= k8s/base
   OPERATOR_RBAC ?= k8s/overlays/rbac-operator.yaml
   ```

2. **Update `deploy` target** to apply the full manifest directory:
   ```makefile
   deploy: ## Apply k8s manifests and wait for Ready
   	kubectl apply -f $(K8S_MANIFESTS)
   	kubectl wait --for=condition=Ready pod -l app=claude-agent \
   		-n $(NAMESPACE) --timeout=120s
   ```

3. **Update `redeploy` target** to use manifest directory:
   ```makefile
   redeploy: build load ## Rebuild image, load into KIND, restart pod
   	kubectl delete pod -l app=claude-agent -n $(NAMESPACE) --ignore-not-found
   	kubectl apply -f $(K8S_MANIFESTS)
   	kubectl wait --for=condition=Ready pod -l app=claude-agent \
   		-n $(NAMESPACE) --timeout=120s
   ```

4. **Add new targets** for operator RBAC management:
   ```makefile
   deploy-operator: ## Apply operator-tier RBAC (opt-in elevated permissions)
   	kubectl apply -f $(OPERATOR_RBAC)

   undeploy-operator: ## Remove operator-tier RBAC
   	kubectl delete -f $(OPERATOR_RBAC) --ignore-not-found
   ```

5. **Update `bootstrap` target** -- no change needed to logic since it calls `$(MAKE) load deploy` which will use the updated deploy target.

6. **Update `.PHONY`** to include new targets: deploy-operator, undeploy-operator.

7. **Keep POD_MANIFEST variable** but remove it from active use (or add comment noting it is for Phase 3 dev pod only). The `deploy` and `redeploy` targets now use K8S_MANIFESTS instead.

Do NOT change: build, load, teardown, status, help targets. These remain the same.
  </action>
  <verify>
    Makefile has K8S_MANIFESTS: grep "K8S_MANIFESTS" Makefile
    Makefile has OPERATOR_RBAC: grep "OPERATOR_RBAC" Makefile
    deploy uses K8S_MANIFESTS: grep "K8S_MANIFESTS" Makefile | grep -q "deploy\|apply"
    deploy-operator target exists: grep "deploy-operator:" Makefile
    undeploy-operator target exists: grep "undeploy-operator:" Makefile
    Makefile syntax valid: make -n deploy (dry-run, should not error on syntax)
  </verify>
  <done>
    Makefile updated with K8S_MANIFESTS and OPERATOR_RBAC variables. deploy and redeploy targets use k8s/base/ manifests. New deploy-operator and undeploy-operator targets manage opt-in RBAC. bootstrap workflow uses the new manifest set. make -n deploy validates syntax.
  </done>
</task>

</tasks>

<verification>
1. k8s/overlays/rbac-operator.yaml exists and passes dry-run validation
2. Operator ClusterRole has exactly: delete pods, create pods/exec, update/patch deployments+statefulsets
3. Makefile deploy target uses k8s/base/ instead of kind/pod.yaml
4. make deploy-operator and make undeploy-operator targets exist
5. Full manifest validation: kubectl apply --dry-run=client -f k8s/base/ && kubectl apply --dry-run=client -f k8s/overlays/rbac-operator.yaml
</verification>

<success_criteria>
- Operator RBAC overlay validates independently and adds only the specified mutation verbs
- Makefile `make deploy` applies k8s/base/ manifests (not the bare Pod)
- Makefile `make deploy-operator` applies the operator overlay
- `kubectl apply -f k8s/base/` does NOT include the operator overlay (directory isolation verified)
- `make -n bootstrap` shows correct command sequence: build, cluster create, load, apply k8s/base/, wait
</success_criteria>

<output>
After completion, create `.planning/phases/04-kubernetes-manifests-rbac/04-02-SUMMARY.md`
</output>
