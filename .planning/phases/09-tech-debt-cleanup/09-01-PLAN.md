---
phase: 09-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .dockerignore
  - docker/.dockerignore
  - k8s/base/04-statefulset.yaml
  - helm/claude-in-a-box/values.yaml
  - helm/claude-in-a-box/tests/golden/values.golden.yaml
  - helm/claude-in-a-box/tests/golden/values-readonly.golden.yaml
  - helm/claude-in-a-box/tests/golden/values-operator.golden.yaml
  - helm/claude-in-a-box/tests/golden/values-airgapped.golden.yaml
  - README.md
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - ".dockerignore at repo root excludes .git, .planning, tests/, kind/, .github/, helm/ from Docker build context"
    - "readiness.sh is the readiness probe command in StatefulSet and Helm values (not healthcheck.sh)"
    - "Readiness probe timeoutSeconds is 10 in StatefulSet and Helm values"
    - "All 4 Helm golden files reflect the readiness.sh probe change"
    - "README line 243 uses app=claude-in-a-box (not app=claude-agent) in the Helm verification section"
    - "REQUIREMENTS.md marks DEV-01, DEV-02, DEV-03, DEV-05, DOC-01 as [x] with Complete status"
  artifacts:
    - path: ".dockerignore"
      provides: "Docker build context exclusions at correct location"
      contains: ".git"
    - path: "k8s/base/04-statefulset.yaml"
      provides: "StatefulSet with readiness.sh readiness probe"
      contains: "readiness.sh"
    - path: "helm/claude-in-a-box/values.yaml"
      provides: "Helm default values with readiness.sh readiness probe"
      contains: "readiness.sh"
  key_links:
    - from: ".dockerignore"
      to: "docker/Dockerfile"
      via: "Docker build context filtering"
      pattern: "\\.git|tests/|kind/"
    - from: "helm/claude-in-a-box/values.yaml"
      to: "helm/claude-in-a-box/tests/golden/*.golden.yaml"
      via: "helm template output must match golden files"
      pattern: "readiness\\.sh"
---

<objective>
Fix Docker build context bloat, wire readiness probe in production manifests, correct README Helm label, and update REQUIREMENTS.md checkboxes.

Purpose: Close 4 of 6 tech debt items from the v1.0 milestone audit -- build context efficiency, auth-aware readiness, documentation accuracy, and requirement tracking.
Output: Corrected .dockerignore, updated StatefulSet/Helm probes, regenerated golden files, fixed README, updated REQUIREMENTS.md.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-MILESTONE-AUDIT.md
@.planning/phases/09-tech-debt-cleanup/09-RESEARCH.md
@docker/.dockerignore
@docker/Dockerfile
@k8s/base/04-statefulset.yaml
@helm/claude-in-a-box/values.yaml
@README.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix .dockerignore location and exclusions</name>
  <files>
    .dockerignore
    docker/.dockerignore
  </files>
  <action>
    Create `.dockerignore` at the repo root with these patterns:
    ```
    # Build context exclusions for claude-in-a-box
    # Docker reads .dockerignore from the build context root (./)
    # NOT from alongside the Dockerfile (docker/.dockerignore is ignored)
    .git
    .gitignore
    .planning
    .claude
    *.md
    LICENSE
    tests/
    kind/
    .github/
    helm/
    ```

    Then delete `docker/.dockerignore` (dead code -- Docker never read it from that location).

    IMPORTANT: Do NOT exclude `scripts/`, `.mcp.json`, or `.claude/skills/` -- the Dockerfile COPY directives reference these paths. Cross-check every COPY source in `docker/Dockerfile` against the new `.dockerignore` patterns before finalizing.

    Verify the image still builds: `docker build -f docker/Dockerfile -t claude-in-a-box:test .`
  </action>
  <verify>
    1. `cat .dockerignore` shows the patterns above
    2. `test ! -f docker/.dockerignore` -- old file is deleted
    3. `docker build -f docker/Dockerfile -t claude-in-a-box:test .` succeeds without "COPY failed" errors
    4. Build context should be noticeably smaller (no .git directory transferred)
  </verify>
  <done>
    .dockerignore exists at repo root with correct exclusions. docker/.dockerignore is deleted. Docker build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire readiness.sh as readiness probe in StatefulSet and Helm</name>
  <files>
    k8s/base/04-statefulset.yaml
    helm/claude-in-a-box/values.yaml
    helm/claude-in-a-box/tests/golden/values.golden.yaml
    helm/claude-in-a-box/tests/golden/values-readonly.golden.yaml
    helm/claude-in-a-box/tests/golden/values-operator.golden.yaml
    helm/claude-in-a-box/tests/golden/values-airgapped.golden.yaml
  </files>
  <action>
    **StatefulSet** (`k8s/base/04-statefulset.yaml`):
    Change the readinessProbe (lines 64-69) from:
    ```yaml
    readinessProbe:
      exec:
        command: ["/usr/local/bin/healthcheck.sh"]
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 5
    ```
    to:
    ```yaml
    readinessProbe:
      exec:
        command: ["/usr/local/bin/readiness.sh"]
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 10
    ```
    Keep the livenessProbe unchanged (healthcheck.sh, timeoutSeconds: 5).

    **Helm values** (`helm/claude-in-a-box/values.yaml`):
    Change the readinessProbe section (lines 92-97) from:
    ```yaml
    readinessProbe:
      exec:
        command: ["/usr/local/bin/healthcheck.sh"]
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 5
    ```
    to:
    ```yaml
    readinessProbe:
      exec:
        command: ["/usr/local/bin/readiness.sh"]
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 10
    ```

    **DO NOT** change `kind/pod.yaml` -- the dev pod intentionally keeps healthcheck.sh for readiness so `make bootstrap` works without an OAuth token (per research recommendation option c).

    **Regenerate all 4 Helm golden files:**
    ```bash
    bash scripts/helm-golden-test.sh --update
    ```
    This captures the new readiness probe config in the golden file snapshots.

    Verify golden files pass: `bash scripts/helm-golden-test.sh`
  </action>
  <verify>
    1. `grep -A3 'readinessProbe' k8s/base/04-statefulset.yaml` shows `readiness.sh` and `timeoutSeconds: 10`
    2. `grep -A3 'readinessProbe' helm/claude-in-a-box/values.yaml` shows `readiness.sh` and `timeoutSeconds: 10`
    3. `grep 'healthcheck.sh' k8s/base/04-statefulset.yaml` still appears in livenessProbe
    4. `grep 'healthcheck.sh' kind/pod.yaml` confirms dev pod is unchanged
    5. `bash scripts/helm-golden-test.sh` passes (golden files match template output)
    6. `grep 'readiness.sh' helm/claude-in-a-box/tests/golden/values.golden.yaml` confirms golden files updated
  </verify>
  <done>
    readiness.sh is the readiness probe in StatefulSet and Helm values with timeoutSeconds: 10. Liveness probes unchanged. Dev pod unchanged. All 4 golden files regenerated and passing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix README Helm label and update REQUIREMENTS.md checkboxes</name>
  <files>
    README.md
    .planning/REQUIREMENTS.md
  </files>
  <action>
    **README.md line 243 only:**
    Change:
    ```bash
    kubectl get pods -l app=claude-agent
    ```
    to:
    ```bash
    kubectl get pods -l app=claude-in-a-box
    ```
    This is in the Helm deployment section (around line 240-245, under "Verification:"). DO NOT change lines 100 or 150 -- those are in the KIND/raw-manifests section where `app=claude-agent` IS correct.

    **REQUIREMENTS.md** -- change 5 checkboxes from `[ ]` to `[x]`:
    1. `[ ] **DEV-01**` -> `[x] **DEV-01**`
    2. `[ ] **DEV-02**` -> `[x] **DEV-02**`
    3. `[ ] **DEV-03**` -> `[x] **DEV-03**`
    4. `[ ] **DEV-05**` -> `[x] **DEV-05**`
    5. `[ ] **DOC-01**` -> `[x] **DOC-01**`

    Also update the traceability table at the bottom -- change these 5 rows from `Pending` to `Complete`:
    - `| DEV-01 | Phase 3: Local Development Environment | Pending |` -> `Complete`
    - `| DEV-02 | Phase 3: Local Development Environment | Pending |` -> `Complete`
    - `| DEV-03 | Phase 3: Local Development Environment | Pending |` -> `Complete`
    - `| DEV-05 | Phase 3: Local Development Environment | Pending |` -> `Complete`
    - `| DOC-01 | Phase 8: Documentation & Release | Pending |` -> `Complete`
  </action>
  <verify>
    1. `grep -n 'app=claude-agent' README.md` shows lines 100 and 150 only (NOT 243)
    2. `grep -n 'app=claude-in-a-box' README.md` shows line 243
    3. `grep '\[ \]' .planning/REQUIREMENTS.md` returns NO matches (all v1 requirements now checked)
    4. `grep -c '\[x\]' .planning/REQUIREMENTS.md` returns 26 (all v1 requirements)
    5. `grep 'Pending' .planning/REQUIREMENTS.md` returns NO matches in the traceability table
  </verify>
  <done>
    README Helm verification command uses correct label selector app=claude-in-a-box. REQUIREMENTS.md has all 26 v1 requirements marked [x] and Complete.
  </done>
</task>

</tasks>

<verification>
1. Docker build succeeds with new .dockerignore: `docker build -f docker/Dockerfile -t claude-in-a-box:test .`
2. Helm golden tests pass: `bash scripts/helm-golden-test.sh`
3. README has correct labels in each section: raw manifests use `app=claude-agent`, Helm uses `app=claude-in-a-box`
4. REQUIREMENTS.md has 0 unchecked v1 items and 0 Pending status rows
5. StatefulSet readinessProbe uses readiness.sh with timeoutSeconds: 10
6. Dev pod (kind/pod.yaml) still uses healthcheck.sh for readiness (not changed)
</verification>

<success_criteria>
- .dockerignore at repo root; docker/.dockerignore deleted
- readiness.sh wired in StatefulSet and Helm values (not dev pod)
- All 4 golden files regenerated and passing
- README line 243 uses app=claude-in-a-box
- REQUIREMENTS.md: DEV-01, DEV-02, DEV-03, DEV-05, DOC-01 marked [x] and Complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-tech-debt-cleanup/09-01-SUMMARY.md`
</output>
