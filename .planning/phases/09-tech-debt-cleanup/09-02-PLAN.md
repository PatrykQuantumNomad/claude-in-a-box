---
phase: 09-tech-debt-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - kind/cluster-test.yaml
  - Makefile
  - .github/workflows/ci.yaml
autonomous: true

must_haves:
  truths:
    - "Test KIND cluster uses name claude-in-a-box-test (distinct from dev cluster claude-in-a-box)"
    - "Makefile test targets use TEST_CLUSTER_NAME variable for cluster operations"
    - "CI pipeline has an integration-tests job that creates a KIND cluster, installs Calico, builds image, deploys manifests, and runs BATS tests"
    - "make test-setup after make bootstrap does NOT skip Calico install (clusters have different names)"
  artifacts:
    - path: "kind/cluster-test.yaml"
      provides: "Test cluster config with distinct name"
      contains: "claude-in-a-box-test"
    - path: "Makefile"
      provides: "Test targets using TEST_CLUSTER_NAME"
      contains: "TEST_CLUSTER_NAME"
    - path: ".github/workflows/ci.yaml"
      provides: "Integration test CI job"
      contains: "integration-tests"
  key_links:
    - from: "Makefile"
      to: "kind/cluster-test.yaml"
      via: "KIND_TEST_CONFIG variable and TEST_CLUSTER_NAME"
      pattern: "TEST_CLUSTER_NAME.*claude-in-a-box-test"
    - from: ".github/workflows/ci.yaml"
      to: "kind/cluster-test.yaml"
      via: "helm/kind-action config parameter"
      pattern: "config: kind/cluster-test.yaml"
    - from: ".github/workflows/ci.yaml"
      to: "tests/integration/*.bats"
      via: "bats --tap command"
      pattern: "bats.*tests/integration"
---

<objective>
Fix test cluster name collision and add BATS integration tests to the CI pipeline.

Purpose: Close the final 2 tech debt items from v1.0 audit -- test cluster isolation prevents false positives when dev and test clusters coexist, and CI integration tests catch RBAC/networking/persistence regressions automatically on every push/PR.
Output: Updated test cluster config, Makefile with TEST_CLUSTER_NAME, CI workflow with integration-tests job.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-MILESTONE-AUDIT.md
@.planning/phases/09-tech-debt-cleanup/09-RESEARCH.md
@kind/cluster-test.yaml
@Makefile
@.github/workflows/ci.yaml
@tests/integration/helpers.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix test cluster name and Makefile test targets</name>
  <files>
    kind/cluster-test.yaml
    Makefile
  </files>
  <action>
    **kind/cluster-test.yaml:**
    Change `name: claude-in-a-box` to `name: claude-in-a-box-test` (line 6).

    **Makefile:**
    1. Add `TEST_CLUSTER_NAME ?= claude-in-a-box-test` in the Test Configuration section (after the existing `KIND_TEST_CONFIG` line).

    2. Update `test-setup` target -- replace all `$(CLUSTER_NAME)` references with `$(TEST_CLUSTER_NAME)`:
    ```makefile
    test-setup: build ## Create test cluster with Calico and deploy
    	scripts/setup-bats.sh
    	@if ! kind get clusters 2>/dev/null | grep -q "^$(TEST_CLUSTER_NAME)$$"; then \
    		echo "Creating test cluster '$(TEST_CLUSTER_NAME)' with Calico CNI..."; \
    		kind create cluster --name $(TEST_CLUSTER_NAME) --config $(KIND_TEST_CONFIG) --wait 60s; \
    		scripts/install-calico.sh; \
    	else \
    		echo "Cluster '$(TEST_CLUSTER_NAME)' already exists, skipping creation"; \
    	fi
    	kind load docker-image $(IMAGE_NAME):$(IMAGE_TAG) --name $(TEST_CLUSTER_NAME)
    	kubectl apply -f $(K8S_MANIFESTS)
    	kubectl wait --for=condition=Ready pod -l app=claude-agent \
    		-n $(NAMESPACE) --timeout=120s
    ```
    Note: the `test-setup` target currently calls `$(MAKE) load deploy` at the end. Replace that with explicit `kind load` using `$(TEST_CLUSTER_NAME)` and the kubectl commands, because the `load` target uses `$(CLUSTER_NAME)` (dev cluster name). The `deploy` target is fine to reuse since it just does kubectl apply which operates on the current context.

    3. Update `test-teardown` target:
    ```makefile
    test-teardown: ## Destroy test cluster
    	kind delete cluster --name $(TEST_CLUSTER_NAME)
    ```

    The `test:` target does not reference cluster name (just runs bats) so it needs no changes.
  </action>
  <verify>
    1. `grep 'name:' kind/cluster-test.yaml` shows `claude-in-a-box-test`
    2. `grep 'TEST_CLUSTER_NAME' Makefile` shows the variable definition and usage in test targets
    3. `grep -c 'CLUSTER_NAME' Makefile` -- verify `test-setup` and `test-teardown` use TEST_CLUSTER_NAME, not CLUSTER_NAME
    4. `grep 'CLUSTER_NAME' Makefile | grep -v TEST_CLUSTER_NAME | grep test` returns empty (no test targets reference bare CLUSTER_NAME)
  </verify>
  <done>
    Test cluster uses name claude-in-a-box-test. Makefile test targets use TEST_CLUSTER_NAME. Dev cluster (claude-in-a-box) and test cluster (claude-in-a-box-test) can coexist without collision.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration-tests job to CI workflow</name>
  <files>
    .github/workflows/ci.yaml
  </files>
  <action>
    Add a new `integration-tests` job to `.github/workflows/ci.yaml` after the existing `helm-lint` job. The job runs in parallel with `build-scan-publish` and `helm-lint` (no `needs:` dependency -- it builds the image independently for simplicity and speed).

    ```yaml
    integration-tests:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up BATS
          uses: bats-core/bats-action@4.0.0

        - name: Create KIND cluster
          uses: helm/kind-action@v1
          with:
            cluster_name: claude-in-a-box-test
            config: kind/cluster-test.yaml
            wait: 120s

        - name: Install Calico CNI
          run: bash scripts/install-calico.sh

        - name: Build and load image
          run: |
            docker build -f docker/Dockerfile -t claude-in-a-box:dev .
            kind load docker-image claude-in-a-box:dev --name claude-in-a-box-test

        - name: Deploy manifests
          run: |
            kubectl apply -f k8s/base/
            kubectl wait --for=condition=Ready pod -l app=claude-agent \
              -n default --timeout=120s

        - name: Run integration tests
          run: bats --tap tests/integration/*.bats
    ```

    Key decisions per research:
    - No `needs:` -- runs in parallel with other jobs for faster total CI time
    - Uses `bats-core/bats-action@4.0.0` (official action, not the local clone)
    - Uses `helm/kind-action@v1` with `config: kind/cluster-test.yaml` and `cluster_name: claude-in-a-box-test`
    - Calico installed via existing `scripts/install-calico.sh` (already has kubectl wait for readiness)
    - Image built locally in this job (avoids GHCR auth complexity on PRs)
    - `wait: 120s` gives KIND time to initialize before Calico install
    - Uses `bats --tap` for TAP-format output (same as Makefile test target)
  </action>
  <verify>
    1. `grep 'integration-tests' .github/workflows/ci.yaml` confirms job exists
    2. `grep 'bats-core/bats-action' .github/workflows/ci.yaml` confirms BATS action used
    3. `grep 'helm/kind-action' .github/workflows/ci.yaml` confirms KIND action used
    4. `grep 'claude-in-a-box-test' .github/workflows/ci.yaml` confirms correct cluster name
    5. `grep 'install-calico' .github/workflows/ci.yaml` confirms Calico install step
    6. `grep -c 'needs:' .github/workflows/ci.yaml` -- integration-tests should NOT have a needs clause (runs in parallel)
    7. YAML syntax check: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yaml'))"` succeeds
  </verify>
  <done>
    CI workflow has integration-tests job that creates KIND cluster with Calico, builds image, deploys manifests, and runs BATS integration tests on every push/PR. Runs in parallel with build-scan-publish and helm-lint.
  </done>
</task>

</tasks>

<verification>
1. `kind/cluster-test.yaml` has `name: claude-in-a-box-test` (distinct from `kind/cluster.yaml` name `claude-in-a-box`)
2. Makefile `test-setup` uses `$(TEST_CLUSTER_NAME)` not `$(CLUSTER_NAME)`
3. Makefile `test-teardown` uses `$(TEST_CLUSTER_NAME)` not `$(CLUSTER_NAME)`
4. CI workflow has 3 jobs: `build-scan-publish`, `helm-lint`, `integration-tests`
5. CI `integration-tests` job uses cluster name `claude-in-a-box-test` matching `kind/cluster-test.yaml`
6. CI YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yaml'))"`
</verification>

<success_criteria>
- Test cluster name is claude-in-a-box-test in both config file and Makefile
- Dev and test clusters can coexist without name collision
- CI runs BATS integration tests in a KIND cluster with Calico on every push/PR
- CI integration-tests job runs in parallel with existing jobs
</success_criteria>

<output>
After completion, create `.planning/phases/09-tech-debt-cleanup/09-02-SUMMARY.md`
</output>
