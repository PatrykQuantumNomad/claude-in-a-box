---
phase: 05-integration-testing
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - tests/integration/01-rbac.bats
  - tests/integration/02-networking.bats
  - tests/integration/03-tools.bats
  - tests/integration/04-persistence.bats
  - tests/integration/05-remote-control.bats
autonomous: true
requirements: [DEV-04]

must_haves:
  truths:
    - "RBAC tests verify reader can get/list/watch 14 resource types and cannot access secrets or mutate"
    - "RBAC tests verify operator tier adds delete pods, create pods/exec, update/patch deployments and statefulsets"
    - "Networking tests confirm DNS resolution for both cluster-internal and external domains"
    - "Networking tests confirm HTTPS egress to Anthropic API on port 443"
    - "Networking tests confirm K8s API access from inside the pod"
    - "Networking tests confirm egress on non-allowed ports is blocked"
    - "Tool verification tests confirm all 30+ tools execute via verify-tools.sh inside the pod"
    - "Persistence tests verify PVC data survives pod deletion and recreation"
    - "Remote Control tests verify outbound HTTPS connectivity to api.anthropic.com"
    - "make test runs all 5 test files and reports pass/fail per category"
  artifacts:
    - path: "tests/integration/01-rbac.bats"
      provides: "RBAC reader and operator permission assertions"
      min_lines: 50
    - path: "tests/integration/02-networking.bats"
      provides: "DNS, egress, K8s API, and blocked port tests"
      min_lines: 30
    - path: "tests/integration/03-tools.bats"
      provides: "Tool verification via existing verify-tools.sh"
      min_lines: 15
    - path: "tests/integration/04-persistence.bats"
      provides: "PVC data survival across pod deletion"
      min_lines: 20
    - path: "tests/integration/05-remote-control.bats"
      provides: "Outbound HTTPS connectivity to Anthropic API"
      min_lines: 10
  key_links:
    - from: "tests/integration/01-rbac.bats"
      to: "k8s/base/02-rbac-reader.yaml"
      via: "kubectl auth can-i --as=SA assertions"
      pattern: "can_i.*pods|services|deployments"
    - from: "tests/integration/01-rbac.bats"
      to: "k8s/overlays/rbac-operator.yaml"
      via: "kubectl apply then can-i assertions"
      pattern: "kubectl apply.*rbac-operator"
    - from: "tests/integration/02-networking.bats"
      to: "k8s/base/03-networkpolicy.yaml"
      via: "In-pod curl/dig testing NetworkPolicy enforcement"
      pattern: "exec_in_pod.*curl|dig"
    - from: "tests/integration/04-persistence.bats"
      to: "k8s/base/04-statefulset.yaml"
      via: "Write to PVC, delete pod, verify data survives"
      pattern: "kubectl delete pod.*wait_for_pod"
    - from: "All test files"
      to: "tests/integration/helpers.bash"
      via: "load helpers"
      pattern: "load helpers"
---

<objective>
Create all five BATS integration test files covering RBAC, networking, tools, persistence, and Remote Control.

Purpose: These test files are the actual test suite that validates the complete Claude-in-a-box system works end-to-end. They test the manifests from Phase 4, the tools from Phase 1, and the networking/persistence guarantees the project promises.
Output: Five executable .bats files that `make test` runs to produce TAP-compliant pass/fail output for each test category.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-testing/05-RESEARCH.md
@.planning/phases/05-integration-testing/05-01-SUMMARY.md

@k8s/base/01-serviceaccount.yaml
@k8s/base/02-rbac-reader.yaml
@k8s/base/03-networkpolicy.yaml
@k8s/base/04-statefulset.yaml
@k8s/overlays/rbac-operator.yaml
@scripts/verify-tools.sh

<interfaces>
<!-- From 05-01: helpers.bash provides these shared constants and functions -->
From tests/integration/helpers.bash:
```bash
POD_NAME="claude-agent-0"
NAMESPACE="default"
SA_NAME="claude-agent"
SA_FULL="system:serviceaccount:${NAMESPACE}:${SA_NAME}"
EXEC_TIMEOUT=30

wait_for_pod()    # kubectl wait --for=condition=Ready pod/claude-agent-0
exec_in_pod()     # kubectl exec claude-agent-0 -- "$@"
can_i()           # kubectl auth can-i $verb $resource --as=$SA_FULL
assert_can()      # run can_i $verb $resource; assert output = "yes"
assert_cannot()   # run can_i $verb $resource; assert output = "no"
```

<!-- From k8s/base/02-rbac-reader.yaml: Reader tier permissions -->
Reader ClusterRole allows get/list/watch on:
- Core: pods, services, events, nodes, namespaces, configmaps, persistentvolumeclaims
- Apps: deployments, statefulsets, daemonsets, replicasets
- Batch: jobs, cronjobs
- Networking: ingresses

Reader ClusterRole DENIES: secrets (not listed), all mutation verbs (create, update, patch, delete)

<!-- From k8s/overlays/rbac-operator.yaml: Operator tier permissions -->
Operator ClusterRole (additive on top of reader) adds:
- delete pods
- create pods/exec
- update/patch deployments.apps
- update/patch statefulsets.apps

<!-- From k8s/base/03-networkpolicy.yaml: Egress rules -->
NetworkPolicy allows egress:
- DNS: UDP/TCP 53 (any destination)
- HTTPS: TCP 443 to 0.0.0.0/0
- K8s API: TCP 6443 to 0.0.0.0/0
All ingress denied.

<!-- From k8s/base/04-statefulset.yaml: Pod identity -->
StatefulSet: claude-agent, pod: claude-agent-0
PVC mount: /app/.claude
ServiceAccount: claude-agent
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RBAC and networking test files</name>
  <files>tests/integration/01-rbac.bats, tests/integration/02-networking.bats</files>
  <action>
Create `tests/integration/01-rbac.bats`:

All tests use `load helpers` at the top. No `setup_file` needed (RBAC tests don't need the pod running).

**Reader tier ALLOW tests** (one @test per resource, using `assert_can` helper):
- "reader: can get pods"
- "reader: can list services"
- "reader: can watch deployments.apps"
- "reader: can list events"
- "reader: can get nodes"
- "reader: can list namespaces"
- "reader: can get configmaps"
- "reader: can list ingresses.networking.k8s.io"
- "reader: can list persistentvolumeclaims"
- "reader: can list jobs.batch"
- "reader: can list cronjobs.batch"
- "reader: can list statefulsets.apps"
- "reader: can list daemonsets.apps"
- "reader: can list replicasets.apps"

**Reader tier DENY tests** (using `assert_cannot` helper):
- "reader: cannot get secrets"
- "reader: cannot delete pods"
- "reader: cannot create pods"
- "reader: cannot update deployments.apps"

**Operator tier tests** -- Use `setup_file()` to apply operator overlay (`kubectl apply -f k8s/overlays/rbac-operator.yaml`) and `teardown_file()` to remove it (`kubectl delete -f k8s/overlays/rbac-operator.yaml --ignore-not-found`). Tests:
- "operator: can delete pods" (assert_can)
- "operator: can create pods/exec" (assert_can)
- "operator: can update deployments.apps" (assert_can)
- "operator: can patch statefulsets.apps" (assert_can)

IMPORTANT for operator tests: BATS runs tests in file order. The operator tests MUST come after the reader DENY tests. Since BATS setup_file/teardown_file apply to the entire file, structure the operator tests as a SEPARATE concern within the file. Apply the overlay in the FIRST operator test and remove it in the LAST operator test's teardown. Alternative: use `setup` and `teardown` per test, but that's wasteful. Best approach: Apply operator overlay before the first operator test using a guard variable, and clean up in teardown_file. Example:
```bash
# At top of file, after load helpers:
OPERATOR_APPLIED=false

# In each operator test, before assertions:
if [ "$OPERATOR_APPLIED" = "false" ]; then
    kubectl apply -f k8s/overlays/rbac-operator.yaml
    OPERATOR_APPLIED=true
fi
```
And in `teardown_file()`:
```bash
teardown_file() {
    kubectl delete -f k8s/overlays/rbac-operator.yaml --ignore-not-found
}
```

Actually, simpler approach: just apply operator overlay before operator tests and remove in teardown_file. Since BATS file-level setup runs once before all tests in the file, but we need reader tests to run WITHOUT the overlay first -- use a dedicated setup function only in operator tests. The cleanest approach: apply the overlay explicitly in the first operator test block and teardown_file removes it. Since kubectl apply is idempotent, even if called multiple times it's fine.

Create `tests/integration/02-networking.bats`:

Use `load helpers` and `setup_file()` that calls `wait_for_pod`.

Tests (all run inside the pod via `exec_in_pod`):
- "dns: resolves kubernetes.default.svc.cluster.local" -- `run exec_in_pod dig +short kubernetes.default.svc.cluster.local`, assert status 0 and output not empty
- "dns: resolves external domain" -- `run exec_in_pod dig +short api.anthropic.com`, assert status 0 and output not empty
- "egress: can reach Anthropic API on port 443" -- `run exec_in_pod curl -sf --max-time 10 -o /dev/null -w "%{http_code}" https://api.anthropic.com/v1/messages`, assert output matches a 3-digit HTTP status code (401/403 is expected and proves connectivity)
- "egress: can reach K8s API server" -- `run exec_in_pod kubectl get --raw /healthz`, assert status 0 and output equals "ok"
- "egress: blocked on non-allowed port 8080" -- `run exec_in_pod curl -sf --max-time 3 -o /dev/null http://1.1.1.1:8080`, assert status is non-zero (timeout or connection refused proves NetworkPolicy blocks it)
  </action>
  <verify>
    bash -n tests/integration/01-rbac.bats 2>/dev/null; grep -c "@test" tests/integration/01-rbac.bats | xargs test 18 -le && grep -c "@test" tests/integration/02-networking.bats | xargs test 5 -le && echo "PASS"
  </verify>
  <done>
    01-rbac.bats has 14 reader ALLOW tests, 4 reader DENY tests, and 4 operator tests (22 total). 02-networking.bats has 5 tests covering DNS, HTTPS egress, K8s API, and blocked port.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tools, persistence, and remote-control test files</name>
  <files>tests/integration/03-tools.bats, tests/integration/04-persistence.bats, tests/integration/05-remote-control.bats</files>
  <action>
Create `tests/integration/03-tools.bats`:

Use `load helpers` and `setup_file()` that calls `wait_for_pod`.

Tests:
- "tools: verify-tools.sh passes inside pod" -- `run exec_in_pod /usr/local/bin/verify-tools.sh`, assert status 0. This single test validates all 30+ tools using the existing Phase 1 script.
- "tools: kubectl is configured for cluster access" -- `run exec_in_pod kubectl get pods -n default`, assert status 0. Validates the ServiceAccount token mount works.
- "tools: kubectl client version matches expected" -- `run exec_in_pod kubectl version --client --output=json`, assert status 0 and output contains "clientVersion".

Create `tests/integration/04-persistence.bats`:

Use `load helpers` and `setup_file()` that calls `wait_for_pod`.

Tests:
- "persistence: can write to PVC mount" -- `run exec_in_pod sh -c 'echo "persistence-marker-$(date +%s)" > /app/.claude/test-marker.txt'`, assert status 0
- "persistence: data survives pod deletion" -- This is the key test:
  1. Write a unique marker: `exec_in_pod sh -c 'echo "persist-test-12345" > /app/.claude/test-marker.txt'`
  2. Delete the pod: `kubectl delete pod "${POD_NAME}" -n "${NAMESPACE}" --timeout=60s`
  3. Wait for StatefulSet to recreate: `wait_for_pod`
  4. Small retry loop to ensure exec path is working: `for i in 1 2 3 4 5; do exec_in_pod echo ok 2>/dev/null && break || sleep 2; done`
  5. Read the marker: `run exec_in_pod cat /app/.claude/test-marker.txt`
  6. Assert status 0 and output equals "persist-test-12345"
- "persistence: cleanup marker file" -- `run exec_in_pod rm -f /app/.claude/test-marker.txt`, assert status 0. Cleanup after persistence tests.

Create `tests/integration/05-remote-control.bats`:

Use `load helpers` and `setup_file()` that calls `wait_for_pod`.

Tests:
- "remote-control: HTTPS egress to api.anthropic.com succeeds" -- `run exec_in_pod curl -sf --max-time 10 -o /dev/null -w "%{http_code}" https://api.anthropic.com/v1/messages`, assert output is a 3-digit HTTP status (any response proves connectivity). Note: This overlaps with the networking egress test intentionally -- Remote Control connectivity is a distinct success criterion that must be independently verifiable.
- "remote-control: TLS handshake succeeds with api.anthropic.com" -- `run exec_in_pod curl -sf --max-time 10 -o /dev/null -w "%{ssl_verify_result}" https://api.anthropic.com/v1/messages`, assert output equals "0" (SSL verify result 0 means success). This validates that the pod can establish a secure TLS connection, which is the transport layer Remote Control uses.

Add a comment at the top of the file explaining:
```
# Remote Control connectivity tests.
# Remote Control uses outbound HTTPS to api.anthropic.com.
# Full Remote Control testing requires a real OAuth token (manual).
# These tests validate the network path is open and TLS works.
```
  </action>
  <verify>
    bash -n tests/integration/03-tools.bats 2>/dev/null; bash -n tests/integration/04-persistence.bats 2>/dev/null; bash -n tests/integration/05-remote-control.bats 2>/dev/null; grep -c "@test" tests/integration/03-tools.bats | xargs test 3 -le && grep -c "@test" tests/integration/04-persistence.bats | xargs test 3 -le && grep -c "@test" tests/integration/05-remote-control.bats | xargs test 2 -le && echo "PASS"
  </verify>
  <done>
    03-tools.bats runs verify-tools.sh inside the pod (3 tests). 04-persistence.bats validates PVC data survives pod deletion (3 tests). 05-remote-control.bats validates HTTPS connectivity and TLS to api.anthropic.com (2 tests). All test files load helpers.bash and have valid BATS syntax.
  </done>
</task>

</tasks>

<verification>
1. All 5 .bats files pass `bash -n` syntax check
2. All .bats files begin with `load helpers`
3. Total @test count across all files >= 30 (comprehensive coverage)
4. 01-rbac.bats covers all 14 reader resources from k8s/base/02-rbac-reader.yaml
5. 01-rbac.bats has teardown_file that removes operator overlay
6. 02-networking.bats tests DNS, HTTPS 443, K8s API 6443, and blocked port
7. 03-tools.bats executes verify-tools.sh inside the pod
8. 04-persistence.bats does write -> delete pod -> wait -> verify cycle
9. 05-remote-control.bats validates HTTPS and TLS to api.anthropic.com
</verification>

<success_criteria>
- 5 BATS test files in tests/integration/ with valid syntax
- RBAC tests cover all 14 reader resources + 4 deny cases + 4 operator cases (22 tests)
- Networking tests cover DNS (internal + external), HTTPS egress, K8s API, blocked port (5 tests)
- Tool tests execute verify-tools.sh inside the running pod (3 tests)
- Persistence tests validate PVC data survives pod delete/recreate (3 tests)
- Remote Control tests validate HTTPS connectivity and TLS to Anthropic API (2 tests)
- Total: ~35 tests covering all 5 success criteria from the ROADMAP
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-testing/05-02-SUMMARY.md`
</output>
