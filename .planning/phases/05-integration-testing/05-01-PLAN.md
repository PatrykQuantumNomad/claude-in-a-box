---
phase: 05-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kind/cluster-test.yaml
  - scripts/install-calico.sh
  - scripts/setup-bats.sh
  - tests/integration/helpers.bash
  - Makefile
autonomous: true
requirements: [DEV-04]

must_haves:
  truths:
    - "KIND test cluster config exists with disableDefaultCNI for Calico"
    - "Calico install script handles operator install, RPF fix, and CoreDNS restart"
    - "BATS setup script downloads bats-core into tests/bats/ if not present"
    - "Test helper library provides wait_for_pod, exec_in_pod, and can_i functions"
    - "make test-setup creates a test cluster with Calico, builds image, loads, deploys"
    - "make test runs BATS against tests/integration/*.bats"
  artifacts:
    - path: "kind/cluster-test.yaml"
      provides: "KIND cluster config with Calico CNI support"
      contains: "disableDefaultCNI: true"
    - path: "scripts/install-calico.sh"
      provides: "Calico CNI installation for KIND"
      contains: "FELIX_IGNORELOOSERPF"
    - path: "scripts/setup-bats.sh"
      provides: "BATS test framework setup"
      contains: "bats-core"
    - path: "tests/integration/helpers.bash"
      provides: "Shared test utilities"
      exports: ["wait_for_pod", "exec_in_pod", "can_i"]
    - path: "Makefile"
      provides: "test and test-setup targets"
      contains: "test-setup"
  key_links:
    - from: "Makefile (test-setup)"
      to: "kind/cluster-test.yaml"
      via: "KIND_TEST_CONFIG variable"
      pattern: "KIND_TEST_CONFIG.*cluster-test"
    - from: "Makefile (test-setup)"
      to: "scripts/install-calico.sh"
      via: "shell invocation after cluster creation"
      pattern: "install-calico"
    - from: "Makefile (test)"
      to: "tests/integration/*.bats"
      via: "BATS binary from tests/bats/"
      pattern: "bats.*integration"
---

<objective>
Create the integration test infrastructure: KIND test cluster config with Calico CNI, Calico installation script, BATS test framework setup, shared test helpers, and Makefile targets.

Purpose: This plan establishes the foundation that all test files (Plan 05-02) depend on. Without Calico, NetworkPolicy tests give false positives. Without BATS, there is no test runner. Without helpers.bash, every test file duplicates boilerplate.
Output: Runnable `make test-setup` that produces a KIND cluster with Calico CNI, BATS installed locally, and helper functions ready for test files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-testing/05-RESEARCH.md

@kind/cluster.yaml
@Makefile
@k8s/base/03-networkpolicy.yaml
@k8s/base/04-statefulset.yaml
@k8s/base/01-serviceaccount.yaml
@k8s/base/02-rbac-reader.yaml
@k8s/overlays/rbac-operator.yaml

<interfaces>
<!-- Existing Makefile variables and targets the new targets must integrate with -->
From Makefile:
```makefile
IMAGE_NAME    ?= claude-in-a-box
IMAGE_TAG     ?= dev
CLUSTER_NAME  ?= claude-in-a-box
NAMESPACE     ?= default
KIND_CONFIG   ?= kind/cluster.yaml
K8S_MANIFESTS ?= k8s/base
OPERATOR_RBAC ?= k8s/overlays/rbac-operator.yaml
# Existing targets: help, build, load, deploy, deploy-operator, undeploy-operator, bootstrap, teardown, redeploy, status
```

From kind/cluster.yaml:
```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: claude-in-a-box
nodes:
  - role: control-plane
  - role: worker
  - role: worker
```

From k8s/base/04-statefulset.yaml:
```yaml
# Pod name: claude-agent-0
# ServiceAccount: claude-agent
# PVC mount: /app/.claude
# Image: claude-in-a-box:dev
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KIND test cluster config and Calico install script</name>
  <files>kind/cluster-test.yaml, scripts/install-calico.sh</files>
  <action>
Create `kind/cluster-test.yaml` based on the existing `kind/cluster.yaml` but with Calico CNI support:
- Same structure: 1 control-plane + 2 workers
- Same name: claude-in-a-box
- Add `networking.disableDefaultCNI: true` to disable kindnet
- Add `networking.podSubnet: 192.168.0.0/16` (Calico default)
- Keep `apiVersion: kind.x-k8s.io/v1alpha4`

Create `scripts/install-calico.sh` (executable, bash):
- Set `CALICO_VERSION` variable defaulting to `3.31.4` (overridable via env)
- Install Calico operator: `kubectl create -f "https://raw.githubusercontent.com/projectcalico/calico/v${CALICO_VERSION}/manifests/tigera-operator.yaml"`
- Install custom resources: `kubectl create -f "https://raw.githubusercontent.com/projectcalico/calico/v${CALICO_VERSION}/manifests/custom-resources.yaml"`
- Wait for tigera-operator deployment: `kubectl wait --for=condition=Available deployment/tigera-operator -n tigera-operator --timeout=120s`
- Fix RPF for KIND nodes: `kubectl -n calico-system set env daemonset/calico-node FELIX_IGNORELOOSERPF=true 2>/dev/null || kubectl -n kube-system set env daemonset/calico-node FELIX_IGNORELOOSERPF=true`
- Wait for calico-node pods ready: `kubectl wait --for=condition=Ready pods -l k8s-app=calico-node -n calico-system --timeout=120s 2>/dev/null || kubectl wait --for=condition=Ready pods -l k8s-app=calico-node -n kube-system --timeout=120s`
- Restart CoreDNS to recover from pre-CNI scheduling: `kubectl -n kube-system rollout restart deployment/coredns` then `kubectl -n kube-system rollout status deployment/coredns --timeout=60s`
- Use `set -euo pipefail`, add echo statements for progress, exit 0 on success
- Make script executable: chmod +x
  </action>
  <verify>
    bash -n scripts/install-calico.sh && grep -q "disableDefaultCNI: true" kind/cluster-test.yaml && grep -q "FELIX_IGNORELOOSERPF" scripts/install-calico.sh && echo "PASS"
  </verify>
  <done>
    kind/cluster-test.yaml has disableDefaultCNI and podSubnet configured. install-calico.sh handles operator install, RPF fix, calico-node readiness wait, and CoreDNS restart.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BATS setup script and test helpers</name>
  <files>scripts/setup-bats.sh, tests/integration/helpers.bash</files>
  <action>
Create `scripts/setup-bats.sh` (executable, bash):
- Check if `tests/bats/bin/bats` already exists; if so, print "BATS already installed" and exit 0
- Otherwise, clone bats-core v1.13.0 into `tests/bats/`: `git clone --depth 1 --branch v1.13.0 https://github.com/bats-core/bats-core.git tests/bats`
- Verify the binary exists after clone: `tests/bats/bin/bats --version`
- Add `tests/bats/` to `.gitignore` if not already present (check first, append if missing)
- Use `set -euo pipefail`

Create `tests/integration/helpers.bash` with shared test utilities:
- Constants:
  - `POD_NAME="claude-agent-0"`
  - `NAMESPACE="default"`
  - `SA_NAME="claude-agent"`
  - `SA_FULL="system:serviceaccount:${NAMESPACE}:${SA_NAME}"`
  - `EXEC_TIMEOUT=30`
- Functions:
  - `wait_for_pod()` -- `kubectl wait --for=condition=Ready "pod/${POD_NAME}" -n "${NAMESPACE}" --timeout=120s`
  - `exec_in_pod()` -- `kubectl exec "${POD_NAME}" -n "${NAMESPACE}" -- "$@"`
  - `can_i()` -- Takes verb and resource args, runs `kubectl auth can-i "${verb}" "${resource}" --as="${SA_FULL}" 2>/dev/null`
  - `can_i_resource()` -- Same as can_i but for resources with API group (e.g., `deployments.apps`). Same implementation as can_i, just a semantic alias for clarity.
  - `assert_can()` -- Wraps can_i, asserts output equals "yes". Takes verb and resource as args.
  - `assert_cannot()` -- Wraps can_i, asserts output equals "no". Takes verb and resource as args.
  </action>
  <verify>
    bash -n scripts/setup-bats.sh && bash -n tests/integration/helpers.bash && grep -q "wait_for_pod" tests/integration/helpers.bash && grep -q "can_i" tests/integration/helpers.bash && echo "PASS"
  </verify>
  <done>
    setup-bats.sh downloads bats-core if not present. helpers.bash exports POD_NAME, SA_FULL, wait_for_pod, exec_in_pod, can_i, assert_can, assert_cannot functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add test and test-setup Makefile targets</name>
  <files>Makefile</files>
  <action>
Add the following to the existing Makefile (append after the existing targets):

New variables (add to the Configuration section at the top):
- `KIND_TEST_CONFIG ?= kind/cluster-test.yaml`
- `BATS ?= tests/bats/bin/bats`
- `TEST_DIR ?= tests/integration`

New targets:

`test-setup: build` -- Create test cluster with Calico CNI, build image, load, deploy:
1. Run `scripts/setup-bats.sh` to ensure BATS is available
2. Check if cluster exists (same pattern as bootstrap); if not:
   - `kind create cluster --name $(CLUSTER_NAME) --config $(KIND_TEST_CONFIG) --wait 60s`
   - `scripts/install-calico.sh`
3. Run `$(MAKE) load deploy`
4. Add `## Create test cluster with Calico and deploy` help comment

`test: ## Run integration test suite` -- Run BATS against all test files:
1. `$(BATS) --tap $(TEST_DIR)/*.bats`

`test-teardown: ## Destroy test cluster` -- Same as teardown (alias for clarity in test context):
1. `kind delete cluster --name $(CLUSTER_NAME)`

Add all three targets to `.PHONY`.

IMPORTANT: Preserve ALL existing Makefile content exactly. Only ADD new variables and targets. Do not modify existing targets.
  </action>
  <verify>
    grep -q "test-setup" Makefile && grep -q "KIND_TEST_CONFIG" Makefile && grep -q "BATS" Makefile && grep -q "test:" Makefile && echo "PASS"
  </verify>
  <done>
    `make test-setup` creates a KIND cluster with Calico CNI, builds/loads/deploys the image. `make test` runs the BATS integration suite. `make test-teardown` destroys the cluster.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/install-calico.sh` -- script syntax valid
2. `bash -n scripts/setup-bats.sh` -- script syntax valid
3. `bash -n tests/integration/helpers.bash` -- helpers syntax valid
4. `grep -q "disableDefaultCNI" kind/cluster-test.yaml` -- Calico CNI support configured
5. `grep -q "test-setup" Makefile && grep -q "test:" Makefile` -- Makefile targets exist
6. `make -n test` -- dry-run of test target succeeds (verifies Makefile syntax)
</verification>

<success_criteria>
- kind/cluster-test.yaml configures a 3-node KIND cluster with Calico CNI support (disableDefaultCNI: true, podSubnet: 192.168.0.0/16)
- scripts/install-calico.sh installs Calico 3.31.4 with RPF fix and CoreDNS restart
- scripts/setup-bats.sh downloads bats-core v1.13.0 into tests/bats/
- tests/integration/helpers.bash provides POD_NAME, SA_FULL constants and wait_for_pod, exec_in_pod, can_i, assert_can, assert_cannot functions
- Makefile has test-setup (cluster + Calico + deploy), test (run BATS), test-teardown targets
- All shell scripts pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-testing/05-01-SUMMARY.md`
</output>
