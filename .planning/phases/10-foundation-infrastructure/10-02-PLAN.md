---
phase: 10-foundation-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - .github/workflows/deploy-site.yaml
  - .github/workflows/ci.yaml
  - .dockerignore
  - site/public/CNAME
autonomous: false

must_haves:
  truths:
    - "Pushing a change to site/ triggers only the deploy-site workflow, not the CI workflow"
    - "Pushing a change outside site/ triggers only the CI workflow, not the deploy-site workflow"
    - "Docker build context does not include the site/ directory"
    - "The CNAME file persists across deploys (lives in site/public/)"
  artifacts:
    - path: ".github/workflows/deploy-site.yaml"
      provides: "GitHub Actions workflow deploying Astro site to GitHub Pages"
      contains: "withastro/action@v5"
    - path: ".github/workflows/ci.yaml"
      provides: "Existing CI workflow with paths-ignore for site/"
      contains: "paths-ignore"
    - path: ".dockerignore"
      provides: "Docker build context exclusions including site/"
      contains: "site/"
    - path: "site/public/CNAME"
      provides: "Custom domain file for GitHub Pages"
      contains: "remotekube.patrykgolabek.dev"
  key_links:
    - from: ".github/workflows/deploy-site.yaml"
      to: "site/"
      via: "paths filter and withastro/action path input"
      pattern: 'path: ./site'
    - from: ".github/workflows/ci.yaml"
      to: "site/"
      via: "paths-ignore filter"
      pattern: 'paths-ignore.*site/\\*\\*'
---

<objective>
Set up CI/CD isolation, GitHub Pages deployment workflow, custom domain CNAME, and Docker build context exclusion.

Purpose: Ensure site changes deploy to GitHub Pages automatically while infrastructure changes trigger the existing CI pipeline independently. The custom domain file and Docker exclusion complete the infrastructure isolation.
Output: deploy-site.yaml workflow, updated ci.yaml with paths-ignore, CNAME file, updated .dockerignore.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-foundation-infrastructure/10-RESEARCH.md
@.planning/phases/10-foundation-infrastructure/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy workflow, update CI paths, add CNAME and .dockerignore</name>
  <files>
    .github/workflows/deploy-site.yaml
    .github/workflows/ci.yaml
    .dockerignore
    site/public/CNAME
  </files>
  <action>
    1. Create `.github/workflows/deploy-site.yaml`:
       ```yaml
       name: Deploy Site

       on:
         push:
           branches: [main]
           paths:
             - "site/**"
         workflow_dispatch:

       permissions:
         contents: read
         pages: write
         id-token: write

       concurrency:
         group: pages
         cancel-in-progress: false

       jobs:
         build:
           runs-on: ubuntu-latest
           steps:
             - name: Checkout
               uses: actions/checkout@v4
             - name: Build Astro site
               uses: withastro/action@v5
               with:
                 path: ./site

         deploy:
           needs: build
           runs-on: ubuntu-latest
           environment:
             name: github-pages
             url: ${{ steps.deployment.outputs.page_url }}
           steps:
             - name: Deploy to GitHub Pages
               id: deployment
               uses: actions/deploy-pages@v4
       ```
       Key details:
       - `paths: ["site/**"]` ensures only site/ changes trigger this workflow
       - `workflow_dispatch` allows manual triggering for debugging
       - `concurrency` group prevents overlapping deploys
       - `withastro/action@v5` with `path: ./site` builds from the site/ subdirectory
       - Permissions include `pages: write` and `id-token: write` for GitHub Pages deployment

    2. Update `.github/workflows/ci.yaml` to add `paths-ignore` on both push and pull_request triggers:
       Change the `on:` block from:
       ```yaml
       on:
         push:
           branches: ["*"]
           tags: ["v*"]
         pull_request:
           branches: [main]
       ```
       To:
       ```yaml
       on:
         push:
           branches: ["*"]
           tags: ["v*"]
           paths-ignore:
             - "site/**"
         pull_request:
           branches: [main]
           paths-ignore:
             - "site/**"
       ```
       IMPORTANT: Do NOT change anything else in ci.yaml. Only add the paths-ignore lines.
       IMPORTANT: You CANNOT use both `paths` and `paths-ignore` on the same trigger. Since CI uses branches (not paths), adding `paths-ignore` is safe.

    3. Create `site/public/CNAME` containing exactly one line:
       ```
       remotekube.patrykgolabek.dev
       ```
       No trailing newline. This file is copied to dist/ during build, ensuring GitHub Pages custom domain persists across deploys.

    4. Add `site/` to `.dockerignore`. Append this line at the end:
       ```
       site/
       ```
       This prevents the site directory (with its node_modules and build artifacts) from bloating the Docker build context.
  </action>
  <verify>
    1. Verify deploy-site.yaml exists and contains the correct path filter:
       ```bash
       grep -q 'paths:' .github/workflows/deploy-site.yaml && echo "paths filter present"
       grep -q 'withastro/action@v5' .github/workflows/deploy-site.yaml && echo "astro action present"
       grep -q 'path: ./site' .github/workflows/deploy-site.yaml && echo "site path configured"
       ```
    2. Verify ci.yaml has paths-ignore:
       ```bash
       grep -q 'paths-ignore' .github/workflows/ci.yaml && echo "paths-ignore present"
       grep -q 'site/\*\*' .github/workflows/ci.yaml && echo "site glob present"
       ```
    3. Verify CNAME:
       ```bash
       cat site/public/CNAME
       ```
       Should output: `remotekube.patrykgolabek.dev`
    4. Verify .dockerignore:
       ```bash
       grep -q 'site/' .dockerignore && echo "site excluded from Docker"
       ```
    5. Verify site still builds with the CNAME file in public/:
       ```bash
       cd site/ && npm run build && ls dist/CNAME
       ```
       The CNAME file should be copied to dist/.
  </verify>
  <done>deploy-site.yaml created with paths filter and withastro/action@v5, ci.yaml updated with paths-ignore for site/**, CNAME file at site/public/CNAME with correct domain, .dockerignore excludes site/, site build still passes and CNAME is in dist/.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure GitHub Pages source and DNS CNAME record</name>
  <what-built>
    All automation is complete:
    - Deploy workflow (`.github/workflows/deploy-site.yaml`) will build and deploy the Astro site on push to main
    - CI workflow updated to ignore site/ changes
    - CNAME file configured for custom domain persistence
    - Docker build context excludes site/

    Two manual steps remain that cannot be automated:
  </what-built>
  <how-to-verify>
    **Step 1: Set GitHub Pages source to "GitHub Actions"**
    1. Go to https://github.com/patrykgolabek/claude-in-a-box/settings/pages
       (or Settings > Pages in the repo)
    2. Under "Build and deployment" > "Source", select **"GitHub Actions"** (not "Deploy from a branch")
    3. Save

    **Step 2: Create DNS CNAME record**
    1. Go to your DNS provider for `patrykgolabek.dev`
    2. Create a CNAME record:
       - Host/Name: `remotekube`
       - Value/Target: `patrykgolabek.github.io`
       - TTL: 300 (or auto)
    3. Save

    **Step 3: Verify DNS propagation** (may take up to 24 hours, but usually minutes)
    ```bash
    dig remotekube.patrykgolabek.dev CNAME +short
    ```
    Expected output: `patrykgolabek.github.io.`

    Note: HTTPS enforcement may not be available in GitHub Pages settings until DNS propagation is complete. Once available, enable "Enforce HTTPS" in Settings > Pages.
  </how-to-verify>
  <resume-signal>Type "done" after completing both manual steps (GitHub Pages source + DNS CNAME). The deploy will be verified when the code is pushed to main. If DNS is still propagating, that's fine -- type "done" anyway and HTTPS can be verified later.</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy-site.yaml` exists with `paths: ["site/**"]` and `withastro/action@v5` with `path: ./site`
2. `.github/workflows/ci.yaml` has `paths-ignore: ["site/**"]` on both push and pull_request triggers
3. `site/public/CNAME` contains `remotekube.patrykgolabek.dev`
4. `.dockerignore` contains `site/`
5. `cd site/ && npm run build && ls dist/CNAME` succeeds (CNAME copied to build output)
6. GitHub Pages source is set to "GitHub Actions" (manual verification)
7. DNS CNAME record points `remotekube.patrykgolabek.dev` to `patrykgolabek.github.io` (manual verification)
</verification>

<success_criteria>
- Deploy workflow will trigger only on site/ changes and deploy to GitHub Pages
- CI workflow will NOT trigger on site/ changes
- Custom domain CNAME persists across deploys
- Docker build context excludes site/ directory
- GitHub Pages source and DNS are configured for first deployment
</success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-infrastructure/10-02-SUMMARY.md`
</output>
