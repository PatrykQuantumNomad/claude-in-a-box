---
phase: 03-local-development-environment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yaml
autonomous: true
requirements:
  - DEV-05

must_haves:
  truths:
    - "docker compose up starts Claude-in-a-box in standalone mode without Kubernetes"
    - "Docker Compose builds the image from docker/Dockerfile if not present"
    - "Docker Compose passes CLAUDE_MODE and auth env vars to the container"
    - "Named volume persists Claude data across container restarts"
  artifacts:
    - path: "docker-compose.yaml"
      provides: "Standalone non-Kubernetes deployment"
      contains: "claude-agent"
  key_links:
    - from: "docker-compose.yaml"
      to: "docker/Dockerfile"
      via: "build.dockerfile field"
      pattern: "dockerfile:.*docker/Dockerfile"
    - from: "docker-compose.yaml"
      to: "scripts/healthcheck.sh"
      via: "healthcheck.test command"
      pattern: "healthcheck\\.sh"
---

<objective>
Create the Docker Compose file for standalone (non-Kubernetes) deployment of Claude-in-a-box.

Purpose: Provides an alternative deployment path for users who want to run the container directly with Docker Compose, without setting up a KIND cluster. This is the simplest way to get Claude-in-a-box running.

Output: docker-compose.yaml
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-local-development-environment/03-RESEARCH.md
@docker/Dockerfile
@scripts/healthcheck.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker Compose file for standalone deployment</name>
  <files>docker-compose.yaml</files>
  <action>
Create `docker-compose.yaml` at the project root using Docker Compose v2 specification (Compose Spec).

**Critical:** Do NOT include a `version:` key -- it is deprecated in Docker Compose v2 and produces warnings. The file starts directly with `services:`.

**Service definition** (`claude-agent`):
- `build.context: .` (project root, matching existing docker build convention)
- `build.dockerfile: docker/Dockerfile` (existing Dockerfile path)
- `image: claude-in-a-box:dev` (tag the built image, matching project convention)
- `container_name: claude-agent`
- `environment:` -- pass through from host env with defaults:
  - `CLAUDE_MODE: ${CLAUDE_MODE:-interactive}` (default to interactive for standalone use)
  - `CLAUDE_CODE_OAUTH_TOKEN: ${CLAUDE_CODE_OAUTH_TOKEN:-}` (empty default -- user provides)
  - `ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}` (empty default -- alternative auth)
- `volumes:` -- mount named volume for persistence:
  - `claude-data:/home/agent/.claude` (persist OAuth tokens and session data between restarts. Use /home/agent/.claude because the container user is `agent` with home at /home/agent per Phase 1 Dockerfile)
- `stdin_open: true` (equivalent to `docker run -i`, needed for interactive mode)
- `tty: true` (equivalent to `docker run -t`, needed for interactive mode)
- `restart: unless-stopped` (auto-restart on crashes, but not after explicit stop)
- `healthcheck:` -- Docker-level health monitoring:
  - `test: ["CMD", "/usr/local/bin/healthcheck.sh"]`
  - `interval: 30s`
  - `timeout: 5s`
  - `start_period: 15s`
  - `retries: 3`

**Top-level volumes:**
- `claude-data:` (named volume declaration, uses default local driver)

Do NOT add: `ports:` (no inbound ports needed -- Remote Control uses outbound HTTPS only), `networks:` (default bridge is fine), `depends_on:` (single service), `deploy:` (not using Swarm).
  </action>
  <verify>
    <automated>docker compose -f docker-compose.yaml config --quiet 2>&1 && echo "PASS" || echo "FAIL: docker-compose.yaml is invalid"</automated>
    <manual>Verify docker-compose.yaml exists, has no version key, defines claude-agent service with correct build context, environment variables, volume mount, and healthcheck</manual>
  </verify>
  <done>docker-compose.yaml exists at project root, passes `docker compose config` validation, defines claude-agent service with build from docker/Dockerfile, environment passthrough for CLAUDE_MODE and auth tokens, named volume for persistence, stdin/tty for interactive mode, and healthcheck using healthcheck.sh.</done>
</task>

</tasks>

<verification>
1. `docker-compose.yaml` exists at project root
2. `docker compose config` validates the file without errors
3. No `version:` key present (Compose v2 spec)
4. Service uses `docker/Dockerfile` for build
5. Environment variables use host passthrough with defaults
6. Named volume `claude-data` is declared and mounted
7. Healthcheck references `/usr/local/bin/healthcheck.sh`
</verification>

<success_criteria>
- docker-compose.yaml is valid per `docker compose config`
- File uses Compose v2 spec (no version key)
- Service builds from docker/Dockerfile with project root context
- CLAUDE_MODE, CLAUDE_CODE_OAUTH_TOKEN, and ANTHROPIC_API_KEY are configurable via host env
- Named volume persists /home/agent/.claude
- Healthcheck uses existing healthcheck.sh script
</success_criteria>

<output>
After completion, create `.planning/phases/03-local-development-environment/03-02-SUMMARY.md`
</output>
