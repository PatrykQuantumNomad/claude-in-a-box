---
phase: 03-local-development-environment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kind/cluster.yaml
  - kind/pod.yaml
  - Makefile
autonomous: true
requirements:
  - DEV-01
  - DEV-02
  - DEV-03

must_haves:
  truths:
    - "KIND cluster config defines 1 control-plane + 2 worker nodes"
    - "Dev pod manifest uses claude-in-a-box:dev with imagePullPolicy IfNotPresent"
    - "Makefile bootstrap target creates cluster idempotently, builds image, loads into KIND, deploys pod"
    - "Makefile teardown target destroys cluster cleanly"
    - "Makefile redeploy target rebuilds image, loads into KIND, restarts pod without cluster recreation"
  artifacts:
    - path: "kind/cluster.yaml"
      provides: "KIND cluster configuration"
      contains: "kind.x-k8s.io/v1alpha4"
    - path: "kind/pod.yaml"
      provides: "Minimal dev pod manifest"
      contains: "claude-in-a-box:dev"
    - path: "Makefile"
      provides: "Build-load-deploy automation"
      contains: "bootstrap"
  key_links:
    - from: "Makefile"
      to: "kind/cluster.yaml"
      via: "KIND_CONFIG variable"
      pattern: "KIND_CONFIG.*kind/cluster\\.yaml"
    - from: "Makefile"
      to: "kind/pod.yaml"
      via: "POD_MANIFEST variable"
      pattern: "POD_MANIFEST.*kind/pod\\.yaml"
    - from: "Makefile"
      to: "docker/Dockerfile"
      via: "build target"
      pattern: "docker build -f docker/Dockerfile"
---

<objective>
Create the KIND cluster configuration, dev pod manifest, and Makefile that together deliver the one-command local Kubernetes development workflow.

Purpose: This is the core of Phase 3 -- enabling `make bootstrap`, `make teardown`, and `make redeploy` as the primary developer workflow for building, deploying, and iterating on the claude-in-a-box image in a local Kubernetes cluster.

Output: kind/cluster.yaml, kind/pod.yaml, Makefile
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-local-development-environment/03-RESEARCH.md
@docker/Dockerfile
@scripts/healthcheck.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KIND cluster config and dev pod manifest</name>
  <files>kind/cluster.yaml, kind/pod.yaml</files>
  <action>
Create the `kind/` directory and two YAML files.

**kind/cluster.yaml** -- KIND cluster configuration:
- Use `apiVersion: kind.x-k8s.io/v1alpha4` and `kind: Cluster`
- Set `name: claude-in-a-box` in the config
- Define 3 nodes: 1 with `role: control-plane`, 2 with `role: worker`
- No extra networking, port mappings, or mount config needed for Phase 3

**kind/pod.yaml** -- Minimal dev pod manifest:
- `apiVersion: v1`, `kind: Pod`
- `metadata.name: claude-agent-0` (matches Phase 4's StatefulSet naming convention)
- `metadata.namespace: default`
- `metadata.labels.app: claude-agent` (used by Makefile for label selectors)
- Single container `claude-agent`:
  - `image: claude-in-a-box:dev`
  - `imagePullPolicy: IfNotPresent` (critical -- avoids the `:latest` pull trap with KIND)
  - `env`: set `CLAUDE_MODE` to `interactive`
  - Liveness probe only using exec `/usr/local/bin/healthcheck.sh` with `initialDelaySeconds: 10`, `periodSeconds: 30`, `timeoutSeconds: 5`
  - Use liveness probe as readiness probe too (same exec command) so pod reaches Ready state without requiring auth credentials. This is the dev manifest -- full auth-aware readiness comes in Phase 4.
  - `stdin: true` and `tty: true` for interactive mode support

Do NOT add: readiness probe calling `claude auth status` (requires auth tokens unavailable in dev), resource limits (Phase 4), volumes/PVCs (Phase 4), RBAC references (Phase 4). Keep this manifest minimal -- it exists only for Phase 3 dev testing.
  </action>
  <verify>
    <automated>cat kind/cluster.yaml | grep -c "role:" | grep -q "3" && grep -q "kind.x-k8s.io/v1alpha4" kind/cluster.yaml && grep -q "claude-in-a-box:dev" kind/pod.yaml && grep -q "imagePullPolicy: IfNotPresent" kind/pod.yaml && grep -q "app: claude-agent" kind/pod.yaml && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>kind/cluster.yaml defines a 3-node cluster (1 control-plane, 2 workers) with v1alpha4 API. kind/pod.yaml defines a minimal pod using claude-in-a-box:dev with IfNotPresent pull policy, liveness+readiness probes using healthcheck.sh, and app=claude-agent label.</done>
</task>

<task type="auto">
  <name>Task 2: Create Makefile with build-load-deploy automation</name>
  <files>Makefile</files>
  <action>
Create a project-root Makefile with these characteristics:

**Variables section** (all overridable with `?=`):
- `IMAGE_NAME ?= claude-in-a-box`
- `IMAGE_TAG ?= dev`
- `CLUSTER_NAME ?= claude-in-a-box`
- `NAMESPACE ?= default`
- `KIND_CONFIG ?= kind/cluster.yaml`
- `POD_MANIFEST ?= kind/pod.yaml`

**Targets** (all declared `.PHONY`):

1. `help` (default target) -- Print available targets with descriptions. Use the `grep -E` + `awk` pattern from research to auto-extract `## comments` from targets.

2. `build` -- `docker build -f docker/Dockerfile -t $(IMAGE_NAME):$(IMAGE_TAG) .`
   Help comment: `## Build the Docker image`

3. `load` -- `kind load docker-image $(IMAGE_NAME):$(IMAGE_TAG) --name $(CLUSTER_NAME)`
   Help comment: `## Load image into KIND cluster`

4. `deploy` -- `kubectl apply -f $(POD_MANIFEST)` then `kubectl wait --for=condition=Ready pod -l app=claude-agent -n $(NAMESPACE) --timeout=120s`
   Help comment: `## Apply pod manifest and wait for Ready`

5. `bootstrap` -- Idempotent full setup. Depends on `build` target. Body:
   - Check if cluster exists: `kind get clusters 2>/dev/null | grep -q "^$(CLUSTER_NAME)$$"` (note: `$$` escapes the `$` for Make)
   - If not exists: `kind create cluster --name $(CLUSTER_NAME) --config $(KIND_CONFIG) --wait 60s`
   - If exists: print "Cluster already exists, skipping creation"
   - Then call `$(MAKE) load deploy`
   Help comment: `## Create KIND cluster, build image, load, and deploy`

6. `teardown` -- `kind delete cluster --name $(CLUSTER_NAME)` (already idempotent -- no error if cluster doesn't exist)
   Help comment: `## Destroy the KIND cluster`

7. `redeploy` -- Depends on `build load`. Body:
   - `kubectl delete pod -l app=claude-agent -n $(NAMESPACE) --ignore-not-found`
   - `kubectl apply -f $(POD_MANIFEST)` (re-apply manifest -- bare Pods are not recreated by a controller after deletion, unlike Deployments/StatefulSets)
   - `kubectl wait --for=condition=Ready pod -l app=claude-agent -n $(NAMESPACE) --timeout=120s`
   Help comment: `## Rebuild image, load into KIND, restart pod`

8. `status` -- Show cluster and pod status:
   - `kind get clusters 2>/dev/null || echo "No clusters"`
   - `echo "---"`
   - `kubectl get pods -n $(NAMESPACE) -l app=claude-agent 2>/dev/null || echo "No pods"`
   Help comment: `## Show cluster and pod status`

**Critical Makefile formatting:**
- Use TABS (not spaces) for recipe indentation -- this is a Makefile requirement
- Use `@` prefix for echo/print commands to suppress Make's command echo
- Use `$$` to escape shell `$` signs inside Make recipes
- Use backslash line continuations for multi-line shell commands in a single recipe line
- The `help` target must be the first (default) target

Do NOT add: test targets (Phase 5), helm targets (Phase 7), or compose targets (Docker Compose is a separate workflow). Keep the Makefile focused on the KIND workflow.
  </action>
  <verify>
    <automated>grep -q "^bootstrap:" Makefile && grep -q "^teardown:" Makefile && grep -q "^redeploy:" Makefile && grep -q "^build:" Makefile && grep -q "^load:" Makefile && grep -q "^deploy:" Makefile && grep -q "^status:" Makefile && grep -q ".PHONY" Makefile && grep -q "KIND_CONFIG" Makefile && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Makefile exists at project root with all required targets (help, build, load, deploy, bootstrap, teardown, redeploy, status), configurable variables, .PHONY declarations, and idempotent bootstrap/teardown logic. `make help` prints all available targets.</done>
</task>

</tasks>

<verification>
1. `kind/cluster.yaml` exists with v1alpha4 API, 3 nodes (1 control-plane, 2 workers)
2. `kind/pod.yaml` exists with claude-in-a-box:dev, IfNotPresent, app=claude-agent label, liveness+readiness probes
3. `Makefile` exists with all 8 targets, configurable variables, .PHONY declarations
4. `make help` outputs target descriptions (run as dry verification -- does not require KIND)
5. All files are syntactically valid (YAML parses, Makefile has tabs)
</verification>

<success_criteria>
- kind/cluster.yaml, kind/pod.yaml, and Makefile exist with correct content
- `make help` runs without error and lists all targets
- Makefile references kind/cluster.yaml via KIND_CONFIG and kind/pod.yaml via POD_MANIFEST
- Bootstrap logic checks for existing cluster before creating
- All targets use configurable variables (not hardcoded values)
</success_criteria>

<output>
After completion, create `.planning/phases/03-local-development-environment/03-01-SUMMARY.md`
</output>
