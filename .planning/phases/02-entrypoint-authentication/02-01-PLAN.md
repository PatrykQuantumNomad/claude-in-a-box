---
phase: 02-entrypoint-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/entrypoint.sh
  - scripts/healthcheck.sh
  - scripts/readiness.sh
  - docker/Dockerfile
autonomous: true
requirements: [ENT-01, ENT-02, ENT-03, ENT-04, ENT-05]

must_haves:
  truths:
    - "CLAUDE_MODE env var dispatches to correct Claude Code invocation (remote-control, interactive, headless)"
    - "Entrypoint uses exec to replace shell process with Claude Code for direct signal delivery"
    - "CLAUDE_CODE_OAUTH_TOKEN env var is respected for non-interactive authentication"
    - "Auth failure in non-interactive modes prints human-readable remediation steps and exits non-zero"
    - "healthcheck.sh confirms Claude Code process is alive via pgrep"
    - "readiness.sh confirms authentication is valid via claude auth status"
    - "Dockerfile COPY entrypoint and health scripts into image and sets CMD through entrypoint.sh"
  artifacts:
    - path: "scripts/entrypoint.sh"
      provides: "Mode dispatch, auth validation, exec handoff"
      contains: "exec claude"
    - path: "scripts/healthcheck.sh"
      provides: "Liveness probe (process alive check)"
      contains: "pgrep"
    - path: "scripts/readiness.sh"
      provides: "Readiness probe (auth status check)"
      contains: "claude auth status"
    - path: "docker/Dockerfile"
      provides: "Updated image with entrypoint scripts and HEALTHCHECK"
      contains: "COPY.*entrypoint.sh"
  key_links:
    - from: "docker/Dockerfile"
      to: "scripts/entrypoint.sh"
      via: "COPY and CMD directive"
      pattern: "CMD.*entrypoint"
    - from: "scripts/entrypoint.sh"
      to: "Claude Code CLI"
      via: "exec builtin replacing shell"
      pattern: "exec claude"
    - from: "docker/Dockerfile"
      to: "scripts/healthcheck.sh"
      via: "COPY and HEALTHCHECK directive"
      pattern: "HEALTHCHECK.*healthcheck"
---

<objective>
Create the entrypoint script with mode dispatch, auth validation, and exec handoff, plus liveness/readiness probe scripts, and wire them into the Dockerfile.

Purpose: The entrypoint is the bridge between the container runtime and Claude Code. It must route to the correct startup mode, validate authentication before starting non-interactive modes, use exec for proper signal handling, and expose health check scripts for Kubernetes probes and Docker HEALTHCHECK.

Output: Three new scripts (entrypoint.sh, healthcheck.sh, readiness.sh) and an updated Dockerfile with COPY directives, HEALTHCHECK, and CMD pointing to entrypoint.sh.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-entrypoint-authentication/02-RESEARCH.md
@.planning/phases/01-container-foundation/01-01-SUMMARY.md
@docker/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entrypoint.sh with mode dispatch, auth validation, and exec handoff</name>
  <files>scripts/entrypoint.sh</files>
  <action>
Create scripts/entrypoint.sh as a bash script with set -euo pipefail. The script must:

1. **Read CLAUDE_MODE env var** (default: "interactive"). Valid values: remote-control, interactive, headless.

2. **Auth validation function (validate_auth):**
   - If CLAUDE_CODE_OAUTH_TOKEN is set and non-empty: log "[entrypoint] OAuth token provided via CLAUDE_CODE_OAUTH_TOKEN" and return 0.
   - Else if ANTHROPIC_API_KEY is set and non-empty: log "[entrypoint] API key provided via ANTHROPIC_API_KEY" and return 0.
   - Else if ~/.claude/.credentials.json exists: log "[entrypoint] Found existing credentials file" and return 0.
   - Else if CLAUDE_MODE is "interactive": log "[entrypoint] No credentials found; interactive login will be prompted" and return 0 (interactive mode can handle login).
   - Else (non-interactive mode with no auth): print the AUTHENTICATION REQUIRED error box (see research Pattern 1 for exact format -- includes 4 remediation options: CLAUDE_CODE_OAUTH_TOKEN, ANTHROPIC_API_KEY, mount credentials, start interactive) and exit 1.

3. **Verify onboarding flag:** Check that /app/.claude.json exists and contains "hasCompletedOnboarding". If missing, warn: "[entrypoint] WARNING: /app/.claude.json missing or incomplete -- Claude Code may show onboarding wizard".

4. **Mode dispatch with exec:**
   - remote-control: `exec claude remote-control --verbose`
   - interactive: `exec claude --dangerously-skip-permissions`
   - headless: If CLAUDE_PROMPT env var is set, `exec claude -p "$CLAUDE_PROMPT" --output-format json --dangerously-skip-permissions`. If CLAUDE_PROMPT is not set, log an error explaining that headless mode requires CLAUDE_PROMPT env var and exit 1.
   - Unknown mode: Print error with valid modes list and exit 1.

5. **Logging prefix:** All log messages use "[entrypoint]" prefix for grep-ability.

Do NOT:
- Start a background health server (exec probes are the primary approach per research recommendation -- this avoids the orphaned-background-process problem documented in Pitfall 4).
- Call `claude auth status` in the entrypoint (it spawns Node.js and adds 3-5s startup latency per research Pitfall 6). Auth validation is file/env-var checks only.
- Trap signals (tini handles signal forwarding; exec replaces the shell so signals go directly to Claude Code per ENT-02).

Make the file executable (chmod +x).
  </action>
  <verify>
    <automated>bash -n scripts/entrypoint.sh && echo "Syntax OK"</automated>
    <manual>Review that exec is the last command in each case branch, no background processes are started, and auth error messages are human-readable</manual>
  </verify>
  <done>entrypoint.sh passes bash syntax check, contains exec claude in all three mode branches, prints structured auth error for non-interactive modes without credentials, and does not call claude auth status or start background processes</done>
</task>

<task type="auto">
  <name>Task 2: Create healthcheck.sh and readiness.sh probe scripts</name>
  <files>scripts/healthcheck.sh, scripts/readiness.sh</files>
  <action>
Create two minimal probe scripts:

**scripts/healthcheck.sh** (liveness probe -- is Claude Code process alive?):
```bash
#!/usr/bin/env bash
# Liveness probe: Is the Claude Code process running?
# Used by: Docker HEALTHCHECK, Kubernetes exec liveness probe
# Returns: 0 (healthy) or 1 (unhealthy)
pgrep -f "claude" > /dev/null 2>&1
```

**scripts/readiness.sh** (readiness probe -- is Claude Code authenticated and ready?):
```bash
#!/usr/bin/env bash
# Readiness probe: Is Claude Code authenticated and ready to serve?
# Used by: Kubernetes exec readiness probe
# Returns: 0 (ready) or 1 (not ready)
# Note: This spawns a Node.js process (~3-5s). Use 30s+ probe intervals per research guidance.
claude auth status > /dev/null 2>&1
```

Both files must be executable (chmod +x). Keep them minimal -- the entire script is the command and its exit code. No logging, no extra logic.
  </action>
  <verify>
    <automated>bash -n scripts/healthcheck.sh && bash -n scripts/readiness.sh && echo "Both scripts syntax OK"</automated>
  </verify>
  <done>healthcheck.sh uses pgrep to check for claude process, readiness.sh uses claude auth status, both pass bash syntax check, both are executable</done>
</task>

<task type="auto">
  <name>Task 3: Update Dockerfile to COPY entrypoint and health scripts, add HEALTHCHECK and CMD</name>
  <files>docker/Dockerfile</files>
  <action>
Update the runtime stage of docker/Dockerfile to incorporate the new scripts. Add the following AFTER the existing verify-tools.sh COPY line (before the ENTRYPOINT line):

1. **COPY the three new scripts:**
```dockerfile
# -- Copy entrypoint and health check scripts from build context ----------------
COPY --chown=agent:agent scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
COPY --chown=agent:agent scripts/healthcheck.sh /usr/local/bin/healthcheck.sh
COPY --chown=agent:agent scripts/readiness.sh /usr/local/bin/readiness.sh
RUN chmod +x /usr/local/bin/entrypoint.sh /usr/local/bin/healthcheck.sh /usr/local/bin/readiness.sh
```

2. **Add HEALTHCHECK directive** (after the COPY block, before ENTRYPOINT):
```dockerfile
# -- Docker HEALTHCHECK using liveness probe script ----------------------------
HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
  CMD ["/usr/local/bin/healthcheck.sh"]
```

3. **Update CMD** (keep existing ENTRYPOINT as tini, change CMD to entrypoint.sh):
The existing `ENTRYPOINT ["/usr/local/bin/tini", "--"]` stays unchanged.
Replace `CMD ["bash"]` with `CMD ["/usr/local/bin/entrypoint.sh"]`.

This means: tini is PID 1 -> tini exec's entrypoint.sh -> entrypoint.sh exec's claude. Signal chain: Docker SIGTERM -> tini -> Claude Code process (entrypoint.sh is gone after exec).

Do NOT remove or modify the existing ENTRYPOINT line -- tini must remain PID 1.
Do NOT add any ENV for CLAUDE_MODE in the Dockerfile (it should default to "interactive" in entrypoint.sh, and be overridden at runtime via -e flag).
  </action>
  <verify>
    <automated>grep -q "entrypoint.sh" docker/Dockerfile && grep -q "healthcheck.sh" docker/Dockerfile && grep -q "readiness.sh" docker/Dockerfile && grep -q "HEALTHCHECK" docker/Dockerfile && grep -q 'CMD.*entrypoint' docker/Dockerfile && echo "Dockerfile updated correctly"</automated>
  </verify>
  <done>Dockerfile COPYs all three scripts to /usr/local/bin/, includes HEALTHCHECK directive pointing to healthcheck.sh, CMD points to entrypoint.sh, ENTRYPOINT remains tini</done>
</task>

</tasks>

<verification>
All scripts pass bash -n syntax check. Dockerfile contains COPY for entrypoint.sh, healthcheck.sh, readiness.sh. HEALTHCHECK directive present. CMD points to entrypoint.sh. ENTRYPOINT still uses tini.
</verification>

<success_criteria>
- scripts/entrypoint.sh exists with mode dispatch (3 modes), auth validation (4 methods), exec handoff, and human-readable auth error
- scripts/healthcheck.sh exists with pgrep-based liveness check
- scripts/readiness.sh exists with claude auth status readiness check
- docker/Dockerfile COPYs all three scripts, has HEALTHCHECK, CMD points to entrypoint.sh, ENTRYPOINT unchanged (tini)
- All files pass bash syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-entrypoint-authentication/02-01-SUMMARY.md`
</output>
