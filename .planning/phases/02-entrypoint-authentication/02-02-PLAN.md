---
phase: 02-entrypoint-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - docker/Dockerfile
  - scripts/entrypoint.sh
  - scripts/healthcheck.sh
  - scripts/readiness.sh
autonomous: false
requirements: [ENT-01, ENT-02, ENT-03, ENT-04, ENT-05]

must_haves:
  truths:
    - "Docker image builds successfully with entrypoint scripts included"
    - "Container starts in interactive mode by default (CMD runs entrypoint.sh)"
    - "CLAUDE_MODE=remote-control starts Claude Code in remote-control mode"
    - "Container without auth credentials in non-interactive mode prints remediation steps and exits 1"
    - "SIGTERM to the container results in graceful shutdown (exit 0 or 143, not 137/SIGKILL)"
    - "healthcheck.sh returns 0 when Claude Code process is running"
    - "Docker HEALTHCHECK reports healthy when Claude Code is running"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "Buildable image with entrypoint and health probes"
      contains: "CMD.*entrypoint"
  key_links:
    - from: "tini (PID 1)"
      to: "entrypoint.sh"
      via: "CMD directive"
      pattern: "tini.*entrypoint"
    - from: "entrypoint.sh"
      to: "Claude Code process"
      via: "exec builtin"
      pattern: "exec claude"
    - from: "Docker HEALTHCHECK"
      to: "healthcheck.sh"
      via: "HEALTHCHECK CMD"
      pattern: "HEALTHCHECK.*healthcheck"
---

<objective>
Build the updated Docker image, verify all Phase 2 success criteria, and fix any issues found during build or testing.

Purpose: Validate that the entrypoint, authentication, signal handling, and health probes work correctly in the actual container environment. This is where theory meets reality -- the research patterns must work end-to-end.

Output: A verified Docker image that starts in all three modes, handles auth correctly, responds to signals, and reports health status.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-entrypoint-authentication/02-RESEARCH.md
@.planning/phases/02-entrypoint-authentication/02-01-SUMMARY.md
@docker/Dockerfile
@scripts/entrypoint.sh
@scripts/healthcheck.sh
@scripts/readiness.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Docker image and verify entrypoint behavior</name>
  <files>docker/Dockerfile, scripts/entrypoint.sh, scripts/healthcheck.sh, scripts/readiness.sh</files>
  <action>
Build the Docker image and run a series of verification tests. Fix any issues found iteratively (build-verify-fix cycle per Phase 1 pattern).

**Build:**
```bash
docker build -f docker/Dockerfile -t claude-in-a-box:dev .
```
If build fails, fix the issue and rebuild. Common issues: COPY path mismatches, permissions, syntax errors in scripts.

**Verification tests (run each, fix if failing):**

1. **Image built successfully:**
   Confirm `docker images claude-in-a-box:dev` shows the image.

2. **Default mode starts (interactive):**
   ```bash
   # Start container, immediately check entrypoint logs, then stop
   docker run --rm -d --name claude-test claude-in-a-box:dev
   sleep 3
   docker logs claude-test 2>&1 | head -20
   docker stop claude-test
   ```
   Expected: Logs show "[entrypoint]" messages. Container starts without crashing.
   Note: Without auth credentials, interactive mode should still attempt to start (it handles login interactively). If it crashes, that's acceptable for this test -- the entrypoint dispatched correctly.

3. **Auth failure in remote-control mode (no credentials):**
   ```bash
   docker run --rm -e CLAUDE_MODE=remote-control claude-in-a-box:dev 2>&1
   ```
   Expected: Exit code 1. Output contains "AUTHENTICATION REQUIRED" banner with remediation steps. No raw JSON errors.

4. **Auth failure in headless mode (no credentials, no prompt):**
   ```bash
   docker run --rm -e CLAUDE_MODE=headless claude-in-a-box:dev 2>&1
   ```
   Expected: Exit code 1. Output contains either "AUTHENTICATION REQUIRED" (no auth) or headless prompt error (no CLAUDE_PROMPT). The auth check should fire first.

5. **Unknown mode error:**
   ```bash
   docker run --rm -e CLAUDE_MODE=bogus claude-in-a-box:dev 2>&1
   ```
   Expected: Exit code 1. Output contains "Unknown CLAUDE_MODE" and lists valid modes.

6. **Signal handling (SIGTERM -> graceful shutdown):**
   ```bash
   docker run -d --name claude-signal-test claude-in-a-box:dev
   sleep 3
   docker stop --time 10 claude-signal-test
   docker inspect claude-signal-test --format='{{.State.ExitCode}}'
   docker rm claude-signal-test
   ```
   Expected: Exit code is 0 or 143 (SIGTERM), NOT 137 (SIGKILL). Container stops within 10s, not the full grace period.

7. **tini is PID 1:**
   ```bash
   docker run --rm claude-in-a-box:dev cat /proc/1/cmdline | tr '\0' ' '
   ```
   Expected: Shows "tini" in the output. (Note: this overrides CMD so entrypoint doesn't run -- it tests the ENTRYPOINT directive.)

8. **healthcheck.sh in container:**
   ```bash
   docker run --rm claude-in-a-box:dev /usr/local/bin/healthcheck.sh; echo "Exit: $?"
   ```
   Expected: Exit code 1 (no claude process running in this ephemeral test -- that's correct behavior).

9. **Docker HEALTHCHECK status:**
   ```bash
   docker run -d --name claude-health-test claude-in-a-box:dev
   sleep 20
   docker inspect claude-health-test --format='{{.State.Health.Status}}'
   docker stop claude-health-test && docker rm claude-health-test
   ```
   Expected: Health status is "healthy" if Claude Code started, or "unhealthy" if it didn't (both are valid -- we're testing that HEALTHCHECK runs).

10. **Scripts exist at correct paths in container:**
    ```bash
    docker run --rm claude-in-a-box:dev ls -la /usr/local/bin/entrypoint.sh /usr/local/bin/healthcheck.sh /usr/local/bin/readiness.sh
    ```
    Expected: All three files exist, are executable, owned by agent:agent.

If any test fails, fix the root cause in the relevant file (entrypoint.sh, healthcheck.sh, readiness.sh, or Dockerfile), rebuild, and re-run the failing test. Document all fixes made.
  </action>
  <verify>
    <automated>docker run --rm -e CLAUDE_MODE=bogus claude-in-a-box:dev 2>&1 | grep -q "Unknown CLAUDE_MODE" && docker run --rm -e CLAUDE_MODE=remote-control claude-in-a-box:dev 2>&1 | grep -q "AUTHENTICATION" && echo "Core entrypoint tests pass"</automated>
  </verify>
  <done>Docker image builds. Entrypoint dispatches modes correctly. Auth failure produces human-readable error. Signal handling uses exec (no SIGKILL needed). healthcheck.sh and readiness.sh exist and are executable in the image. HEALTHCHECK directive functional.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of entrypoint and auth behavior</name>
  <what-built>
Complete entrypoint system with three startup modes, auth validation, exec-based signal handling, and health probe scripts wired into the Docker image.
  </what-built>
  <how-to-verify>
Run these commands and confirm the expected behavior:

1. **Auth error message quality:**
   ```bash
   docker run --rm -e CLAUDE_MODE=remote-control claude-in-a-box:dev
   ```
   Confirm: You see a clear "AUTHENTICATION REQUIRED" box with numbered remediation steps (not raw JSON or a stack trace).

2. **Unknown mode error:**
   ```bash
   docker run --rm -e CLAUDE_MODE=invalid claude-in-a-box:dev
   ```
   Confirm: You see an error listing valid modes (remote-control, interactive, headless).

3. **Interactive mode starts** (will likely fail auth but should attempt):
   ```bash
   docker run --rm -it claude-in-a-box:dev
   ```
   Confirm: Container starts, shows "[entrypoint] Starting Claude Code in interactive mode" (then likely fails auth -- that's fine). Ctrl+C to exit.

4. **Scripts are in the image:**
   ```bash
   docker run --rm claude-in-a-box:dev ls -la /usr/local/bin/entrypoint.sh /usr/local/bin/healthcheck.sh /usr/local/bin/readiness.sh
   ```
   Confirm: All three scripts exist, are executable, owned by agent.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Docker image builds with entrypoint scripts. All three modes dispatch correctly. Auth failure produces human-readable error. Signal handling via exec confirmed (no SIGKILL). Health probe scripts functional. Human verified output quality.
</verification>

<success_criteria>
- Docker image builds under 2GB with entrypoint scripts included
- CLAUDE_MODE=remote-control|interactive|headless dispatches to correct Claude Code invocation
- Auth failure in non-interactive modes exits 1 with human-readable remediation steps
- Signal handling uses exec (SIGTERM reaches Claude Code directly)
- healthcheck.sh and readiness.sh are executable in the image at /usr/local/bin/
- Docker HEALTHCHECK directive is functional
- Human approves the output quality of error messages and mode dispatch
</success_criteria>

<output>
After completion, create `.planning/phases/02-entrypoint-authentication/02-02-SUMMARY.md`
</output>
