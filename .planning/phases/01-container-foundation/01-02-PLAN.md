---
phase: 01-container-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - docker/Dockerfile
  - scripts/verify-tools.sh
autonomous: false
requirements:
  - IMG-01
  - IMG-02
  - IMG-03
  - IMG-04
  - IMG-05

must_haves:
  truths:
    - "docker build completes successfully and produces an image under 2GB compressed"
    - "docker run <image> claude --version prints a version string as non-root user"
    - "docker run <image> verify-tools.sh reports all non-privileged tools PASS"
    - "tini is PID 1 inside the running container"
    - "Container user is agent with UID 10000"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "Buildable, verified Dockerfile"
      contains: "FROM ubuntu"
    - path: "scripts/verify-tools.sh"
      provides: "Passing verification script"
      contains: "check_tool"
  key_links:
    - from: "docker build"
      to: "docker/Dockerfile"
      via: "docker build -f docker/Dockerfile ."
      pattern: "docker build"
    - from: "verify-tools.sh execution"
      to: "all installed binaries"
      via: "command -v and version checks"
      pattern: "check_tool"
---

<objective>
Build the Docker image from Plan 01's Dockerfile, run the full verification suite, fix any build or runtime issues, and confirm all phase success criteria are met.

Purpose: The Dockerfile from Plan 01 is untested code. This plan builds it, catches inevitable issues (wrong download URLs, missing deps, permission problems), fixes them, and proves the image works end-to-end.
Output: A successfully built and verified Docker image, with any fixes applied to docker/Dockerfile and scripts/verify-tools.sh.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-container-foundation/01-CONTEXT.md
@.planning/phases/01-container-foundation/01-RESEARCH.md
@.planning/phases/01-container-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Docker image and fix all build errors</name>
  <files>docker/Dockerfile, scripts/verify-tools.sh</files>
  <action>
Build the Docker image and iteratively fix any issues until the build succeeds and verification passes.

**Step 1: Initial build**
```bash
cd /Users/patrykattc/work/git/claude-in-a-box
docker build -f docker/Dockerfile -t claude-in-a-box:dev .
```

**Step 2: If build fails, diagnose and fix**
Common issues to expect and fix:
- **404 on binary downloads:** Wrong URL template or architecture naming. Check the exact URL by curling it manually. Fix the URL pattern in the Dockerfile. Watch for: Trivy uses "64bit"/"ARM64", stern filename includes version, helm tarball path includes "linux-{ARCH}".
- **ARG not available in stage:** Forgot to redeclare the ARG after FROM. Add `ARG VARNAME` (no default) in the stage that needs it.
- **apt package not found:** Package name may differ. Check with `apt-cache search`. For example: `dnsutils` not `bind9-dnsutils`, `vim-tiny` not `vim`, `linux-tools-generic` may need `linux-perf` as fallback.
- **Permission errors:** If any COPY or chown fails, check the user/group setup order.
- **npm install fails:** Network issue or version doesn't exist. Verify the Claude Code version exists on npm: `npm view @anthropic-ai/claude-code versions --json | tail -5`.

Iterate: fix -> rebuild -> fix -> rebuild until `docker build` succeeds.

**Step 3: Verify the image**
Run all 5 ROADMAP success criteria checks:

1. **Image size check:**
```bash
docker image inspect claude-in-a-box:dev --format '{{.Size}}' | awk '{printf "%.0f MB\n", $1/1024/1024}'
```
Must be under 2GB (2048 MB) -- this is compressed size, so also check:
```bash
docker images claude-in-a-box:dev --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
```

2. **Claude Code as non-root:**
```bash
docker run --rm claude-in-a-box:dev claude --version
docker run --rm claude-in-a-box:dev id
```
Must show UID 10000, and claude --version must print a version string.

3. **Tool verification:**
```bash
docker run --rm claude-in-a-box:dev verify-tools.sh
```
Must show all non-privileged tools PASS, privileged tools SKIP, 0 FAIL.

4. **Multi-stage build with pinned versions:**
```bash
grep -c "^ARG " docker/Dockerfile
grep ":latest" docker/Dockerfile || echo "No :latest found (GOOD)"
```
Must have 13+ ARGs, zero `:latest` occurrences.

5. **tini as PID 1:**
```bash
docker run --rm -d --name claude-tini-test claude-in-a-box:dev sleep 30
docker exec claude-tini-test cat /proc/1/cmdline | tr '\0' ' '
docker stop claude-tini-test
```
Must show tini in the output.

**Step 4: Fix any verification failures**
If any check fails, diagnose the root cause, edit the Dockerfile or verify-tools.sh, rebuild, and re-verify. Common post-build fixes:
- verify-tools.sh: A tool's `--version` flag may differ from expected (e.g., `k9s version` vs `k9s version --short`). Fix the check command.
- Size over 2GB: Remove `--no-install-recommends` is already set. Consider if any apt package pulled unnecessary deps. Note: per CONTEXT.md, "no strict image size limit -- functionality over size", so this is soft. If slightly over, document it.
- Tools requiring different invocation patterns inside the container vs outside.

**IMPORTANT:** Do NOT change locked decisions to fix issues. If npm install is problematic, debug the npm install -- do not switch to native installer. If a tool version doesn't exist, find the correct latest version and update the ARG.
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/claude-in-a-box && docker build -f docker/Dockerfile -t claude-in-a-box:dev . && docker run --rm claude-in-a-box:dev id | grep -q "10000" && docker run --rm claude-in-a-box:dev claude --version && docker run --rm claude-in-a-box:dev verify-tools.sh && echo "PASS: Image builds and all verifications pass" || echo "FAIL: Build or verification failed"</automated>
  </verify>
  <done>Docker image builds successfully. `docker run claude-in-a-box:dev id` shows UID 10000. `claude --version` prints version. `verify-tools.sh` shows 0 FAIL. `tini` is PID 1. Image is under 2GB compressed. If image exceeds 2GB, user must be notified and approve before proceeding. All fixes applied to Dockerfile and/or verify-tools.sh.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify container image meets all requirements</name>
  <what-built>Complete Docker image with Claude Code and 32+ SRE/DevOps tools running as non-root user (agent, UID 10000) with tini as PID 1. All tools verified via verify-tools.sh.</what-built>
  <how-to-verify>
Run these commands and confirm the output:

1. **Check image exists and note size:**
```bash
docker images claude-in-a-box:dev
```
Expected: Image listed, size under ~2GB

2. **Verify non-root user:**
```bash
docker run --rm claude-in-a-box:dev whoami
docker run --rm claude-in-a-box:dev id
```
Expected: `agent`, `uid=10000(agent) gid=10000(agent)`

3. **Verify Claude Code:**
```bash
docker run --rm claude-in-a-box:dev claude --version
```
Expected: Version string printed (e.g., `2.0.25`)

4. **Run full tool verification:**
```bash
docker run --rm claude-in-a-box:dev verify-tools.sh
```
Expected: 35+ PASS, 0 FAIL, 4 SKIP (privileged tools)

5. **Verify tini as PID 1:**
```bash
docker run --rm -d --name ciab-verify claude-in-a-box:dev sleep 60
docker exec ciab-verify cat /proc/1/cmdline | tr '\0' ' '
docker stop ciab-verify
```
Expected: Output contains "tini"

6. **Spot-check a few tools interactively:**
```bash
docker run --rm -it claude-in-a-box:dev bash
# Inside container:
kubectl version --client
jq --version
trivy --version
exit
```
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All 5 ROADMAP Phase 1 success criteria verified:
1. `docker build` produces image under 2GB with no errors
2. `docker run <image> claude --version` prints version as UID 10000 (non-root) -- note: ROADMAP says UID 1000 but CONTEXT.md locked UID 10000
3. `docker run <image> verify-tools.sh` confirms 32+ tools, 0 failures
4. Multi-stage build with pinned versions, no `:latest`, no unpinned apt-get
5. tini is PID 1 (cat /proc/1/cmdline shows tini)
</verification>

<success_criteria>
- Docker image builds from scratch without errors
- Image size is under 2GB compressed (soft limit per CONTEXT.md)
- All 32+ tools verified (PASS or SKIP for privileged)
- Claude Code responds to --version as non-root user
- tini confirmed as PID 1
- Human has verified the image works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-container-foundation/01-02-SUMMARY.md`
</output>
