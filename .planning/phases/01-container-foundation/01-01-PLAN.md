---
phase: 01-container-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile
  - docker/.dockerignore
  - scripts/verify-tools.sh
autonomous: true
requirements:
  - IMG-01
  - IMG-02
  - IMG-03
  - IMG-04
  - IMG-05

must_haves:
  truths:
    - "docker build completes without errors using the multi-stage Dockerfile"
    - "Dockerfile contains 3+ build stages (tools-downloader, claude-installer, runtime)"
    - "All 32+ tool versions are pinned as ARG variables at the top of the Dockerfile"
    - "No :latest tags or unpinned apt-get install commands exist in the Dockerfile"
    - "Container runs as user agent (UID 10000, GID 10000) with /app as home"
    - "tini is configured as the ENTRYPOINT (PID 1)"
    - "Claude Code is installed via npm with telemetry, auto-updater, and onboarding disabled"
    - "verify-tools.sh tests all 32+ tools with privileged-tool skip handling"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "Multi-stage Docker build producing deployment-ready image"
      contains: "FROM ubuntu:24.04 AS tools-downloader"
      min_lines: 150
    - path: "docker/.dockerignore"
      provides: "Build context exclusions"
      contains: ".git"
    - path: "scripts/verify-tools.sh"
      provides: "Runtime tool verification script"
      contains: "check_tool"
      min_lines: 80
  key_links:
    - from: "docker/Dockerfile"
      to: "scripts/verify-tools.sh"
      via: "COPY --chown=agent:agent scripts/verify-tools.sh"
      pattern: "COPY.*verify-tools\\.sh"
    - from: "docker/Dockerfile (runtime stage)"
      to: "docker/Dockerfile (tools-downloader stage)"
      via: "COPY --from=tools-downloader"
      pattern: "COPY --from=tools-downloader"
    - from: "docker/Dockerfile (runtime stage)"
      to: "docker/Dockerfile (claude-installer stage)"
      via: "COPY --from=claude-installer"
      pattern: "COPY --from=claude-installer"
---

<objective>
Create the multi-stage Dockerfile, .dockerignore, and tool verification script that together produce a deployment-ready Ubuntu 24.04 container image with Claude Code and 32+ SRE/DevOps debugging tools running as a non-root user.

Purpose: This is the foundational build artifact for the entire project. Every subsequent phase (entrypoint, K8s manifests, Helm chart) depends on this image existing and being correct.
Output: docker/Dockerfile, docker/.dockerignore, scripts/verify-tools.sh
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-container-foundation/01-CONTEXT.md
@.planning/phases/01-container-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-stage Dockerfile with all tools, Claude Code, and non-root user</name>
  <files>docker/Dockerfile, docker/.dockerignore</files>
  <action>
Create `docker/Dockerfile` implementing a 3-stage multi-stage build. Use the research document's code examples as the primary reference, but implement the COMPLETE version with all details below.

**Global ARGs (before first FROM):**
Declare ALL version pins as ARG variables with defaults at the very top of the Dockerfile, before the first FROM statement. Include:
- UBUNTU_VERSION=24.04
- NODE_VERSION=22.22.0
- CLAUDE_CODE_VERSION=2.0.25
- TINI_VERSION=0.19.0
- KUBECTL_VERSION=1.35.1
- HELM_VERSION=4.1.1
- K9S_VERSION=0.50.18
- STERN_VERSION=1.33.0
- KUBECTX_VERSION=0.9.5
- JQ_VERSION=1.8.1
- YQ_VERSION=4.52.4
- TRIVY_VERSION=0.68.2
- GRYPE_VERSION=0.109.0

**Stage 1: tools-downloader (FROM ubuntu:${UBUNTU_VERSION} AS tools-downloader)**
- Redeclare needed ARGs (without defaults) in each stage
- Install minimal deps: ca-certificates, curl
- Use TARGETARCH for architecture-aware downloads
- Download ALL static binary tools into /tools/bin/:
  - tini (https://github.com/krallin/tini/releases)
  - kubectl (https://dl.k8s.io)
  - helm (https://get.helm.sh) -- extract from tarball
  - k9s (GitHub releases) -- extract from tarball
  - stern (GitHub releases) -- extract from tarball, note: download filename is stern_${VERSION}_linux_${ARCH}.tar.gz
  - kubectx + kubens (GitHub releases) -- two separate downloads
  - jq (GitHub releases) -- direct binary download
  - yq (GitHub releases) -- direct binary download
  - trivy (GitHub releases) -- NOTE: uses "64bit"/"ARM64" NOT "amd64"/"arm64", need architecture mapping
  - grype (GitHub releases) -- uses standard amd64/arm64
- Handle architecture name mismatches explicitly with case statements where needed
- chmod +x all binaries after download
- Each tool download should be a separate RUN command for better layer caching (discretion: layer caching optimization)

**Stage 2: claude-installer (FROM ubuntu:${UBUNTU_VERSION} AS claude-installer)**
- Redeclare NODE_VERSION and CLAUDE_CODE_VERSION ARGs
- Install deps: ca-certificates, curl, xz-utils
- Download Node.js 22 binary from nodejs.org (direct binary, not nvm or nodesource -- discretion choice):
  - Map amd64->x64 for Node.js URL naming
  - Extract to /usr/local with --strip-components=1
- Install Claude Code via npm (locked decision): `npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}`
- Clean npm cache: `npm cache clean --force`
- Verify: `claude --version`

**Stage 3: runtime (FROM ubuntu:${UBUNTU_VERSION} AS runtime)**
- Add descriptive LABEL metadata (maintainer, description, version)
- Install ALL apt packages in a SINGLE RUN command with `--no-install-recommends`:
  - Network: curl, dnsutils, nmap, tcpdump, wget, netcat-openbsd, iproute2, iputils-ping
  - Process/system: htop, strace, procps, linux-tools-generic, bpftrace
  - Database clients: postgresql-client, default-mysql-client, redis-tools
  - Standard utilities: git, vim-tiny, nano, unzip, file, tree, less, ca-certificates, ripgrep, bash-completion
  - Clean apt cache: `rm -rf /var/lib/apt/lists/*`
- COPY tini from tools-downloader to /usr/local/bin/tini
- COPY all static binaries from tools-downloader to /usr/local/bin/
- COPY Node.js binary from claude-installer: /usr/local/bin/node
- COPY Node.js lib from claude-installer: /usr/local/lib/node_modules
- Create symlinks: claude -> node_modules/.bin/claude, nodejs -> node
- Create non-root user per locked decision:
  - `groupadd -g 10000 agent`
  - `useradd -m -u 10000 -g 10000 -d /app -s /bin/bash agent`
  - UID 10000 per CONTEXT.md locked decision (ROADMAP says 1000 but CONTEXT.md overrides -- it was a deliberate security choice for high UIDs)
  - `mkdir -p /app/.claude /var/log`
  - `chown -R agent:agent /app /tmp /var/log`
- Switch to USER agent, WORKDIR /app
- Pre-configure Claude Code (as agent user):
  - Create /app/.claude.json with `{"hasCompletedOnboarding": true}`
  - Create /app/.claude/settings.json with permissions (Bash, Read, Edit, Write), defaultMode "bypassPermissions", and env vars for disabling autoupdater/telemetry/error-reporting
- Set ENV variables:
  - DISABLE_AUTOUPDATER=1
  - DISABLE_TELEMETRY=1
  - DISABLE_ERROR_REPORTING=1
  - DISABLE_INSTALLATION_CHECKS=1 (suppresses npm deprecation warning)
  - CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
  - HOME=/app
  - PATH="/usr/local/bin:${PATH}"
- COPY verify-tools.sh from build context: `COPY --chown=agent:agent scripts/verify-tools.sh /usr/local/bin/verify-tools.sh`
- chmod +x verify-tools.sh
- ENTRYPOINT ["/usr/local/bin/tini", "--"]
- CMD ["bash"]

**Also create `docker/.dockerignore`:**
```
.git
.gitignore
.planning
.claude
*.md
LICENSE
```

**IMPORTANT NOTES:**
- Do NOT use `:latest` anywhere. Always use `ubuntu:${UBUNTU_VERSION}` with the ARG.
- The Dockerfile build context will be the project root (not docker/), so COPY paths reference from project root.
- Add clear section comments with `# ====` separators between stages for readability.
- For apt packages: do NOT pin to exact versions (e.g., no `curl=8.5.0-2`). Ubuntu 24.04 tag IS the version pin. Exact apt pins are fragile per research recommendations.
- Ensure ALL 32+ tools from the research inventory are included.
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/claude-in-a-box && test -f docker/Dockerfile && test -f docker/.dockerignore && grep -q "FROM ubuntu" docker/Dockerfile && grep -c "^ARG " docker/Dockerfile | xargs test 13 -le && grep -q "AS tools-downloader" docker/Dockerfile && grep -q "AS claude-installer" docker/Dockerfile && grep -q "AS runtime" docker/Dockerfile && grep -q "UID 10000" docker/Dockerfile || grep -q "10000" docker/Dockerfile && grep -q "tini" docker/Dockerfile && grep -q "claude-code" docker/Dockerfile && echo "PASS: Dockerfile structure verified" || echo "FAIL: Dockerfile structure check failed"</automated>
    <manual>Review Dockerfile for completeness: all 3 stages present, all ARGs declared, all tools included, non-root user configured, tini as entrypoint</manual>
  </verify>
  <done>docker/Dockerfile exists with 3 stages (tools-downloader, claude-installer, runtime), all 13+ ARG version pins declared globally, all 32+ tools installed (10 static binaries + 20+ apt packages), agent user with UID 10000, tini entrypoint, Claude Code pre-configured. docker/.dockerignore excludes .git, .planning, .claude, *.md.</done>
</task>

<task type="auto">
  <name>Task 2: Create tool verification script</name>
  <files>scripts/verify-tools.sh</files>
  <action>
Create `scripts/verify-tools.sh` -- a bash script that verifies all installed tools execute correctly as non-root inside the container.

**Script requirements:**
- Shebang: `#!/usr/bin/env bash`
- `set -euo pipefail`
- Define a `check_tool` function accepting: name, command, optional privileged flag
- For normal tools: run the command, report PASS/FAIL
- For privileged tools (strace, tcpdump, perf, bpftrace): check binary EXISTS (`command -v`) but SKIP execution test, report as SKIP
- Track counts: PASS, FAIL, SKIP
- Collect error details in an array

**Tool checklist (must match ALL tools in Dockerfile):**

Network tools (9 checks):
- curl: `curl --version`
- dig: `dig -v` (package: dnsutils)
- nmap: `nmap --version`
- tcpdump: `tcpdump --version` (PRIVILEGED - needs CAP_NET_RAW)
- wget: `wget --version`
- netcat: `nc -h` (package: netcat-openbsd)
- ip: `ip -V` (package: iproute2)
- ss: `ss -V` (package: iproute2)
- ping: `ping -c 1 127.0.0.1` (package: iputils-ping)

Process/system tools (6 checks):
- htop: `htop --version`
- strace: `strace -V` (PRIVILEGED - needs CAP_SYS_PTRACE)
- ps: `ps --version` (package: procps)
- top: `top -v` (package: procps -- note: some versions of top exit non-zero with -v, use `top -v 2>&1 | head -1` or just check `command -v top`)
- perf: `perf version` (PRIVILEGED)
- bpftrace: `bpftrace --version` (PRIVILEGED)

Kubernetes tools (6 checks):
- kubectl: `kubectl version --client`
- helm: `helm version`
- k9s: `k9s version --short`
- stern: `stern --version`
- kubectx: `kubectx --help`
- kubens: `kubens --help`

Data/log tools (3 checks):
- jq: `jq --version`
- yq: `yq --version`
- less: `less --version`

Database clients (3 checks):
- psql: `psql --version`
- mysql: `mysql --version`
- redis-cli: `redis-cli --version`

Security scanning (2 checks):
- trivy: `trivy --version`
- grype: `grype version`

Standard utilities (8 checks):
- git: `git --version`
- vim: `vim --version` (vim-tiny)
- nano: `nano --version`
- unzip: `unzip -v` (note: unzip -v shows version, exits 0)
- file: `file --version`
- tree: `tree --version`
- rg: `rg --version` (ripgrep)
- bash: `bash --version`

Claude Code (2 checks):
- claude: `claude --version`
- node: `node --version`

**Output format:**
```
=== Claude In A Box - Tool Verification ===
Running as: agent (UID: 10000)

[PASS] curl
[PASS] dig
[SKIP] tcpdump (requires elevated privileges)
...

=== Results ===
PASS: 28 | FAIL: 0 | SKIP (privileged): 4
Total tools: 32+

All tools verified successfully.
```

**Exit codes:**
- 0: All non-privileged tools pass
- 1: Any non-privileged tool fails (SKIP does not count as failure)

**Important:** Redirect both stdout and stderr for tool version checks (`&>/dev/null` in the check, but print the status line to stdout). Some tools print version info to stderr.
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/claude-in-a-box && test -f scripts/verify-tools.sh && bash -n scripts/verify-tools.sh && grep -c "check_tool" scripts/verify-tools.sh | xargs test 30 -le && head -1 scripts/verify-tools.sh | grep -q "bash" && echo "PASS: verify-tools.sh syntax valid, 30+ tool checks present" || echo "FAIL: verify-tools.sh validation failed"</automated>
    <manual>Review that every tool from the Dockerfile has a corresponding check_tool entry in verify-tools.sh</manual>
  </verify>
  <done>scripts/verify-tools.sh exists, passes bash -n syntax check, contains 32+ check_tool invocations covering all tools in the Dockerfile, handles 4 privileged tools with SKIP, exits 0 on success and 1 on any non-privileged tool failure.</done>
</task>

</tasks>

<verification>
1. `docker/Dockerfile` exists with 3 named stages and 13+ global ARGs
2. `docker/.dockerignore` excludes build artifacts
3. `scripts/verify-tools.sh` passes bash syntax check and covers all tools
4. No `:latest` tags anywhere in Dockerfile: `grep -c ":latest" docker/Dockerfile` returns 0
5. UID 10000 is used (not 1000): `grep "10000" docker/Dockerfile` returns matches
6. tini is ENTRYPOINT: `grep "ENTRYPOINT" docker/Dockerfile` shows tini
</verification>

<success_criteria>
- Dockerfile has 3 stages: tools-downloader, claude-installer, runtime
- All 13+ version ARGs declared at top with pinned defaults
- All 32+ tools present (10 static binary downloads + 20+ apt packages)
- Claude Code installed via npm with all settings pre-configured
- Non-root user agent with UID 10000/GID 10000
- tini as ENTRYPOINT
- verify-tools.sh covers every installed tool
- No :latest tags, no unpinned installs
</success_criteria>

<output>
After completion, create `.planning/phases/01-container-foundation/01-01-SUMMARY.md`
</output>
